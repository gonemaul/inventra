import{q as pe,v as r,D as k,u as fe,K as ee,x as ye,a as me,l as ie,o as V,e as x,d as ve,p as ue,f as i,g as n,i as he,t as ce,k as be,F as _e}from"./vendor-core-By7Plnkm.js";import{j as ke}from"./vendor-common-GpUWqhKr.js";import xe from"./ConfirmSubmit-JHItRX5M.js";import we from"./Cart-0smm3eZD.js";import{_ as Se}from"./BarcodeScanner-DKRXhBOH.js";import Ce from"./FilterProduct-BlPxgsdl.js";import Fe from"./ProductDetailModal-BqI2Y1FV.js";import qe from"./ProductComparisonModal-Br3KQz45.js";import Me from"./TransactionSuccessModal-DcLP1kNs.js";import Te from"./ProductList-D9HhufKk.js";import Pe from"./PosQtyModal--xmYIGFs.js";import"./vendor-charts-Bw6UNgWf.js";import"./Modal-CAUBCNUq.js";import"./InputRupiah-BV5Iw5HO.js";import"./MoneyInput-DMVledyj.js";import"./vendor-scanner-og__AIM6.js";import"./BottomSheet-WceNnWH3.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";function Ae(v){const p=pe(),C="POS_REALTIME_DRAFT_V3",d=r([]),l=r(!1),I=r(20),h=r(!0),g=r({search:"",category:"all",subCategory:"all",brand:"all",sort:"default",hideEmptyStock:!0}),y=r([]),L=r(""),F=r([]),q=r(null),N=r([]),R=k(()=>v.mode==="edit"),u=v.sale||null,o=fe({id:u?.id||null,input_type:u?.input_type||"realtime",report_date:u?.transaction_date||(()=>{const e=new Date,t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${t}-${a}-${s}`})(),items:u?.items?.map(e=>{const t=e.product,a=e.product_snapshot||{},s=t?.name||a.name||"Unknown Item",f=t?.code||a.code||"-";let c=t?.category;return!c&&a.category&&(c={name:a.category}),{product_id:e.product_id,code:f,name:s,category:c,unit:t?.unit||(a.unit?{name:a.unit}:null),size:t?.size,stock_max:parseFloat(t?.stock||0)+parseFloat(e.quantity),selling_price:parseFloat(e.selling_price),original_price:parseFloat(e.selling_price),quantity:parseFloat(e.quantity),original_quantity:parseFloat(e.quantity),subtotal:parseFloat(e.subtotal)}})||[],customer_id:u?.customer_id||null,payment_amount:u?parseFloat(u.total_payment):0,change_amount:u?parseFloat(u.change_amount):0,payment_method:u?.payment_method||"cash",discount_type:u?.discount_type||"fixed",discount_value:u?.discount_value||0,notes:u?.notes||""}),M=k(()=>o.items.reduce((e,t)=>e+(parseFloat(t.subtotal)||0),0)),J=k(()=>{const e=parseFloat(o.discount_value)||0;if(e<=0)return 0;if(o.discount_type==="percent"){const t=e>100?100:e;return Math.round(M.value*t/100)}return e>M.value?M.value:e}),T=k(()=>{const e=M.value-J.value,t=e>0?e:0;return t===0&&o.payment_amount>0,t}),K=k(()=>(parseFloat(o.payment_amount)||0)-T.value),H=k(()=>o.payment_method!=="cash"&&o.payment_method!==""?!0:(parseFloat(o.payment_amount)||0)>=T.value),Y=k(()=>o.items.some(e=>e.quantity<=0||isNaN(e.quantity))),de=k(()=>{const e=T.value;if(e<=0)return[];const t=[{label:"Uang Pas",value:e}];if([2e3,5e3,1e4,2e4,5e4,1e5].forEach(s=>{s>e&&!t.find(f=>f.value===s)&&t.push({label:D(s),value:s})}),e>5e4){const s=Math.ceil(e/5e4)*5e4;t.find(f=>f.value===s)||t.push({label:D(s),value:s})}return t.slice(0,4)}),b=e=>{e.unit?.is_decimal===1||(e.quantity=Math.round(e.quantity),e.quantity<1&&(e.quantity=1)),e.quantity>e.stock_max&&(e.quantity=e.stock_max,p.warning(`Stok sisa ${e.stock_max}`)),e.subtotal=Math.round(e.quantity*e.selling_price)},te=e=>{const t=parseFloat(e.subtotal)||0,a=parseFloat(e.selling_price)||0;if(!(a<=0))if(e.unit?.is_decimal===1){let s=t/a;s>e.stock_max&&(s=e.stock_max,e.subtotal=Math.round(s*a),p.warning("Melebihi sisa stok!")),e.quantity=parseFloat(s.toFixed(4))}else confirm(`⚠️ Ubah harga satuan agar sesuai total ${D(t)}?`)?e.quantity>0&&(e.selling_price=Math.round(t/e.quantity)):e.subtotal=Math.round(e.quantity*e.selling_price)},O=e=>{e.subtotal=Math.round(e.quantity*e.selling_price)},P=e=>{const t=["Jasa","Layanan"].includes(e.category?.name);if(!t&&parseFloat(e.stock)<=0){p.error("Stok habis!");return}const a=o.items.find(s=>s.product_id===e.id);if(a){if(t){p.warning(`Jasa "${e.name}" sudah ada di keranjang.`);return}if(a.quantity+1>e.stock){p.warning("Stok maksimal!");return}a.quantity++,b(a)}else{const s=parseFloat(e.selling_price||e.price);o.items.push({product_id:e.id,code:e.code,name:e.name,image_url:e.image_url,category:e.category,unit:e.unit,size:e.size,stock_max:parseFloat(e.stock),selling_price:s,original_price:s,quantity:1,original_quantity:0,subtotal:s,is_service:t})}},A=e=>o.items.splice(e,1),U=(e,t)=>{const a=o.items[e],s=parseFloat(a.quantity)+t;if(s>a.stock_max){p.warning(`Stok sisa ${a.stock_max}`);return}if(s<=0){confirm("Hapus item ini?")&&A(e);return}a.quantity=s,b(a)},j=e=>{o.payment_amount=e.value},$=()=>{o.payment_amount=0},z=()=>{d.value.length&&o.items.forEach(e=>{const t=d.value.find(a=>a.id===e.product_id);if(t){const a=e.original_quantity||0,s=parseFloat(t.stock);e.stock_max=s+a,e.quantity>e.stock_max&&(p.warning(`Stok ${e.name} berubah! Disesuaikan ke max: ${e.stock_max}`),e.quantity=e.stock_max,b(e))}})},w=r(new Map),_=r([]),E=r([]),S=async(e={})=>{const t=I.value,a=e.search||g.value.search,s={query:a,limit:t,category_id:a?"all":g.value.category,product_type_id:a?"all":g.value.subCategory,brand_id:a?"all":g.value.brand,sort:g.value.sort,hide_empty_stock:g.value.hideEmptyStock?1:0,size_id:a?"all":g.value.size||"all"},f=JSON.stringify(s);if(w.value.has(f)){const c=w.value.get(f);Array.isArray(c)?d.value=c:(d.value=c.products,_.value=c.available_brands||[],E.value=c.available_sizes||[],c.products.length<t?h.value=!1:h.value=!0),z()}else l.value=!0;try{const m=(await me.get(route("sales.products.lite"),{params:s})).data;let Q=[];Array.isArray(m)?Q=m:(Q=m.products,_.value=m.available_brands||[],E.value=m.available_sizes||[]),d.value=Q,Q.length<t?h.value=!1:h.value=!0,w.value.set(f,m),z()}catch(c){console.error("Gagal load produk:",c),w.value.has(f)||p.error("Gagal memuat database produk")}finally{l.value=!1}},B=ke(()=>{I.value=20,h.value=!0,S()},400);ee(()=>g.value,(e,t)=>{e.search!==t.search?(l.value=!0,B()):((e.category!==t.category||e.subCategory!==t.subCategory||e.brand!==t.brand)&&(I.value=20,h.value=!0,d.value=[]),S())},{deep:!0});const G=k(()=>d.value),ae=()=>{!h.value||l.value||(I.value+=12,S())},oe=async()=>{try{const e=await me.get(route("sales.products.lite"),{params:{only_services:!0,limit:100}});e.data.products?N.value=e.data.products:Array.isArray(e.data)?N.value=e.data:N.value=[]}catch(e){console.error("Gagal load layanan:",e)}},W=e=>{q.value=e,o.customer_id=e.id,F.value=[],L.value=""};ee(L,e=>{if(!e||!v.customers){F.value=[];return}const t=e.toLowerCase(),a=v.customers.filter(s=>s.name.toLowerCase().includes(t)||s.code.toLowerCase().includes(t));F.value=a.slice(0,5)});const se=e=>{const t=v.customers.find(a=>a.member_code==e||a.phone==e);t?W(t):p.warning("Member tidak ditemukan")},ne=()=>{if(R.value)return;const e=localStorage.getItem(C);if(e)try{const t=JSON.parse(e);t.items&&(o.items=t.items),o.payment_amount=t.payment_amount||0,o.payment_method=t.payment_method||"cash",o.notes=t.notes||"",o.discount_type=t.discount_type||"fixed",o.discount_value=t.discount_value||0,t.selectedMember&&(q.value=t.selectedMember,o.customer_id=t.selectedMember.id)}catch{localStorage.removeItem(C)}};ee([()=>o.items,()=>o.customer_id,()=>o.payment_amount,()=>o.discount_value,()=>o.notes],()=>{localStorage.setItem(C,JSON.stringify({items:o.items,customer_id:o.customer_id,payment_amount:o.payment_amount,payment_method:o.payment_method,notes:o.notes,discount_type:o.discount_type,discount_value:o.discount_value,selectedMember:q.value}))},{deep:!0});const re=(e=!1)=>new Promise((t,a)=>{const s=K.value,f=T.value;o.change_amount=s,o.payment_amount=parseFloat(o.payment_amount);const c={onSuccess:m=>{const ge=(m.props.flash||{}).sale_id;R.value||(S(),localStorage.removeItem(C),o.reset(),o.items=[],q.value=null),t({success:!0,saleId:ge,change:s,total:f})},onError:m=>{console.error(m),p.error("Gagal memproses transaksi"),a(m)},onFinish:()=>{}};R.value?o.transform(m=>({...m})).put(route("sales.update",o.id),c):o.transform(m=>({...m,print_invoice:e})).post(route("sales.pos.store"),c)}),D=e=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(e),X=e=>{const t=y.value.findIndex(a=>a.id===e.id);if(t!==-1)y.value.splice(t,1);else{if(y.value.length>=5){p.warning("Maksimal 5 produk untuk perbandingan.");return}y.value.push(e)}},Z=()=>{y.value=[]},le=e=>y.value.some(t=>t.id===e);return ye(()=>{if(S(),oe(),ne(),R.value){const e=new Date().toISOString().slice(0,10);o.report_date=e}}),{form:o,filterState:g,allProducts:d,filteredProducts:G,isFetchingData:l,compareList:y,serviceProducts:N,dynamicBrands:_,dynamicSizes:E,memberSearch:L,memberSearchResults:F,selectedMember:q,subTotal:M,discountAmount:J,grandTotal:T,changeAmount:K,isPaymentSufficient:H,hasInvalidQty:Y,moneySuggestions:de,loadMoreProducts:ae,queryMember:se,addItem:P,removeItem:A,updateQty:U,resetPayment:$,handleMoneyClick:j,recalcFromQty:b,recalcFromSubtotal:te,recalcFromPrice:O,toggleCompare:X,clearCompare:Z,isInCompare:le,submitTransaction:re,rp:D}}const De={class:"flex flex-col lg:flex-row h-[100dvh] w-full bg-gray-100 dark:bg-gray-900 overflow-hidden font-sans transition-colors duration-300"},Ie={class:"relative flex flex-col flex-1 h-full overflow-hidden"},$e={key:0,class:"absolute z-40 bottom-24 lg:bottom-8 right-4 flex items-center bg-gray-900 dark:bg-gray-800 text-white pl-4 pr-1 py-1.5 gap-4 rounded-full shadow-xl animate-bounce-subtle border border-gray-700"},ze={class:"text-xs font-bold whitespace-nowrap"},Ee={class:"flex items-center gap-1"},Be={key:1,class:"absolute z-30 lg:hidden bottom-4 left-4 right-4"},Le={class:"flex items-center gap-3"},Ne={class:"flex items-center justify-center text-xs font-bold text-white rounded-full shadow-sm bg-lime-500 dark:bg-white dark:text-lime-700 w-7 h-7"},Re={class:"flex flex-col items-start leading-none gap-0.5"},Oe={class:"text-lg font-bold"},rt={__name:"index",props:{categories:Array,customers:Array,brands:Array,sale:Object,mode:String},setup(v){const C=Ae(v),{form:d,filterState:l,allProducts:I,filteredProducts:h,isFetchingData:g,dynamicBrands:y,dynamicSizes:L,grandTotal:F,changeAmount:q,isPaymentSufficient:N,hasInvalidQty:R,addItem:u,loadMoreProducts:o,queryProduk:M,queryMember:J,submitTransaction:T,rp:K,toggleCompare:H,clearCompare:Y,isInCompare:de,compareList:b}=C,te=pe(),O=r(!1),P=r(!1),A=r(!1),U=r(!1),j=r(!1),$=r(!1),z=r(!1),w=r(!1),_=r("product"),E=r(null);r(null),ee(l,async()=>{},{deep:!0});const S=()=>{U.value=!1,d.reset(),d.items=[]},B=r({id:null,name:"",code:"",price:0,quantity:1,stock:0,unit:"Pcs",image:null}),G=e=>{B.value={id:e.id,name:e.name,code:e.code,image_url:e.image_url,price:parseFloat(e.selling_price||e.price||0),quantity:1,stock:parseInt(e.stock||0),unit:e.unit?.name||"Pcs"},$.value=!0},ae=e=>{const t={id:e.id,name:e.name,code:e.code,image_url:e.image_url,price:parseFloat(e.selling_price||e.price||0),quantity:1,stock:parseInt(e.stock||0),unit:e.unit?.name||"Pcs"};u(t)},oe=e=>{E.value=e,z.value=!0},W=()=>{_.value="product",P.value=!0},se=()=>{_.value="member",P.value=!0},ne=async e=>{if(P.value=!1,alert("scan berhasil "+_.value+" | "+e),_.value=="product")try{const t=await M(e);t?(e=t,G(e)):alert("Produk tidak ditemukan di database.")}catch(t){console.error("Terjadi kesalahan saat query produk:",t),alert("Gagal mengambil data produk.")}else _.value=="member"&&(e=J(e))},re=(e=!1)=>{u(B.value),$.value=!1,e&&W()},D=r(0),X=r(0),Z=r(null),le=e=>{j.value=!0,T(e).then(t=>{j.value=!1,A.value=!1,t.success?(D.value=t.change,X.value=t.total,U.value=!0,Z.value?.resetStep()):te.success("Transaksi berhasil disimpan.")})};return(e,t)=>(V(),ie(_e,null,[x(n(he),{title:"Kasir POS"}),x(Fe,{show:z.value,product:E.value,onClose:t[0]||(t[0]=a=>z.value=!1),onAddToCart:t[1]||(t[1]=a=>{G(a)})},null,8,["show","product"]),x(qe,{show:w.value,products:n(b),onClose:t[2]||(t[2]=a=>w.value=!1),onRemove:n(H),onAddToCart:t[3]||(t[3]=a=>{G(a)})},null,8,["show","products","onRemove"]),P.value?(V(),ve(Se,{key:0,onResult:ne,onClose:t[4]||(t[4]=a=>P.value=!1)})):ue("",!0),i("div",De,[i("div",Ie,[x(Ce,{categories:v.categories,brands:n(y)?.length?n(y):v.brands,sizes:n(L),"is-fetching":n(g),search:n(l).search,"onUpdate:search":t[5]||(t[5]=a=>n(l).search=a),category:n(l).category,"onUpdate:category":t[6]||(t[6]=a=>n(l).category=a),subCategory:n(l).subCategory,"onUpdate:subCategory":t[7]||(t[7]=a=>n(l).subCategory=a),brand:n(l).brand,"onUpdate:brand":t[8]||(t[8]=a=>n(l).brand=a),size:n(l).size,"onUpdate:size":t[9]||(t[9]=a=>n(l).size=a),sort:n(l).sort,"onUpdate:sort":t[10]||(t[10]=a=>n(l).sort=a),hideEmptyStock:n(l).hideEmptyStock,"onUpdate:hideEmptyStock":t[11]||(t[11]=a=>n(l).hideEmptyStock=a),onScan:W},null,8,["categories","brands","sizes","is-fetching","search","category","subCategory","brand","size","sort","hideEmptyStock"]),x(Te,{products:n(h),"is-fetching":n(g),"cart-items":n(d).items,"all-products-count":n(I).length,"compare-list":n(b),onLoadMore:n(o),onAddToCart:ae,onOpenDetail:oe,onToggleCompare:n(H)},null,8,["products","is-fetching","cart-items","all-products-count","compare-list","onLoadMore","onToggleCompare"]),n(b)?.length>0?(V(),ie("div",$e,[i("div",ze,ce(n(b).length)+" Banding ",1),i("div",Ee,[i("button",{onClick:t[12]||(t[12]=a=>w.value=!0),class:"px-3 py-1.5 bg-lime-500 hover:bg-lime-400 text-black text-xs font-bold rounded-full transition"}," Buka "),i("button",{onClick:t[13]||(t[13]=(...a)=>n(Y)&&n(Y)(...a)),class:"p-1.5 hover:bg-gray-700 rounded-full text-gray-400 hover:text-white transition"},[...t[20]||(t[20]=[i("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[i("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])])])):ue("",!0),n(d).items.length>0?(V(),ie("div",Be,[i("button",{onClick:t[14]||(t[14]=a=>O.value=!0),class:"w-full bg-gray-900 dark:bg-lime-600 text-white p-3.5 rounded-2xl shadow-xl shadow-gray-900/20 flex justify-between items-center animate-bounce-subtle"},[i("div",Le,[i("span",Ne,ce(n(d).items.reduce((a,s)=>a+parseFloat(s.quantity),0)),1),i("div",Re,[t[21]||(t[21]=i("span",{class:"text-[9px] text-gray-400 dark:text-lime-100 uppercase font-bold tracking-wider"},"Total Belanja",-1)),i("span",Oe,ce(n(K)(n(F))),1)])]),t[22]||(t[22]=i("span",{class:"flex items-center gap-1 px-4 py-2 text-xs font-bold bg-gray-700 dark:bg-lime-800/30 rounded-xl"},[be(" Bayar "),i("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[i("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M14 5l7 7m0 0l-7 7m7-7H3"})])],-1))])])):ue("",!0)]),x(we,{ref_key:"cartRef",ref:Z,showMobileCart:O.value,reprops:n(C),onOpenScanMember:se,onShowBayar:t[15]||(t[15]=a=>A.value=!0),onShowDesktop:t[16]||(t[16]=a=>O.value=!1)},null,8,["showMobileCart","reprops"])]),x(Pe,{show:$.value,item:B.value,"onUpdate:item":t[17]||(t[17]=a=>B.value=a),onClose:t[18]||(t[18]=a=>$.value=!1),onAddToCart:re},null,8,["show","item"]),x(xe,{showConfirmModal:A.value,changeAmount:n(q),grandTotal:n(F),paymentAmount:parseFloat(n(d).payment_amount),processing:j.value,onClose:t[19]||(t[19]=a=>A.value=!1),onConfirmTransaction:le},null,8,["showConfirmModal","changeAmount","grandTotal","paymentAmount","processing"]),x(Me,{show:U.value,changeAmount:D.value,total:X.value,onClose:S,onNewTransaction:S},null,8,["show","changeAmount","total"])],64))}};export{rt as default};
