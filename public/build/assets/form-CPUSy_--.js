import{y as M,u as N,x as j,E as V,z,j as b,R as O,g as k,o as v,a as c,d as s,h as P,w as q,b as o,k as Q,A as T,t as E,l as U,f as $,n as B,i as G,F as K}from"./app-CKedD50u.js";import{P as H}from"./PrimaryButton-DC8fjAi-.js";import{_ as L}from"./InputLabel-y1vBpa56.js";import{d as J}from"./debounce-CUkf89vi.js";import Y from"./ProductSearch-Byy0Jd2M.js";import W from"./SaleTable-DrGUGXzy.js";import{u as X}from"./useActionLoading-BwM9d4Sa.js";import{_ as Z}from"./AuthenticatedLayout-BAy_ahgd.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";function ee(i){const d=M(),m="POS_RECAP_DRAFT_V1",a=N({report_date:i?.sale?.transaction_date||new Date().toISOString().substr(0,10),items:[]}),r=j([]),p=j(!1),w=["kg","kilogram","gram","gr","g","ons","ton","kwintal","mg","liter","ltr","l","ml","cc","m3","kubik","galon","meter","mtr","m","cm","mm","m2","yard","kaki","inch","inci"];V(()=>{const e=localStorage.getItem(m);let t=[],l="",u=[];if(e)try{const n=JSON.parse(e);n.items&&n.items.length>0&&(t=n.items,l=n.notes||"")}catch{localStorage.removeItem(m)}i?.mode==="edit"&&i.sale?.items?(u=i.sale.items.map(n=>({product_id:n.product_id,code:n.product_snapshot?.code,name:n.product_snapshot?.name,unit:n.product_snapshot?.unit,category:n.product_snapshot?.category,brand:n.product_snapshot?.brand,stock_max:parseFloat(n.product?.stock||0)+parseFloat(n.quantity),image:n.product?.image,selling_price:parseFloat(n.selling_price),is_price_locked:!0,is_total_locked:!0,quantity:parseFloat(n.quantity),subtotal:parseFloat(n.subtotal)})),t.length>0?(a.items=[...u,...t],a.notes=l||i.sale?.notes||"",console.log("Data digabung: Database + Local Storage")):(a.items=u,a.notes=i.sale?.notes||"")):t.length>0&&(a.items=t,a.notes=l)}),z(()=>a.items,e=>{localStorage.setItem(m,JSON.stringify({items:e,notes:a.notes}))},{deep:!0});const g=e=>e&&w.includes(e.toLowerCase()),S=(e,t)=>{g(t)||(e.key==="."||e.key===",")&&e.preventDefault()},F=e=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(e),f=b(()=>a.items.some(e=>parseFloat(e.quantity)<=0)),h=b(()=>a.items.some(e=>parseFloat(e.quantity)>parseFloat(e.stock_max))),I=e=>{if(parseFloat(e.stock)<=0){d.error("Stok habis. Tidak bisa ditambahkan.");return}const t=a.items.find(l=>l.product_id===e.id);if(t){if(t.quantity+1>e.stock){d.error("Melebihi sisa stok!");return}t.quantity++,x(t)}else a.items.push({product_id:e.id,code:e.code,name:e.name,unit:e.unit,category:e.category?.name||"-",brand:e.brand||"-",stock_max:parseFloat(e.stock),image:e.image,selling_price:parseFloat(e.price),is_price_locked:!0,is_total_locked:!0,quantity:1,subtotal:parseFloat(e.price)})},C=e=>a.items.splice(e,1),x=e=>{const t=parseFloat(e.quantity)||0,l=parseFloat(e.selling_price)||0;e.subtotal=Math.round(t*l)},D=e=>{const t=parseFloat(e.subtotal)||0,l=parseFloat(e.selling_price)||0;if(l>0){let u=t/l;e.quantity=g(e.unit)?parseFloat(u.toFixed(4)):Math.round(u)}},A=J(async e=>{if(!e){r.value=[];return}p.value=!0;try{const t=await O.get(route("sales.search-product"),{params:{query:e}});r.value=t.data,console.log(t)}catch(t){console.error(t)}finally{p.value=!1}},300),y=()=>{if(a.items.length===0){d.error("Keranjang masih kosong!");return}if(f.value){d.error("Ada produk dengan Qty 0. Mohon isi jumlah barang atau hapus dari list.");return}if(h.value){const e=a.items.find(t=>parseFloat(t.quantity)>parseFloat(t.stock_max));d.error(`Stok tidak cukup untuk produk: ${e.name}. (Sisa: ${e.stock_max})`);return}i?.mode==="edit"?a.put(route("sales.update",i.sale.id),{onSuccess:()=>{localStorage.removeItem(m),a.reset(),a.items=[]},onError:e=>{console.error(e),d.error("Gagal menyimpan. Periksa inputan.")}}):i?.mode==="create"&&(console.log("store"),a.post(route("sales.store"),{onSuccess:()=>{localStorage.removeItem(m),a.reset(),a.items=[]},onError:e=>{console.error(e),d.error("Gagal menyimpan. Periksa inputan.")}}))},_=b(()=>a.items.reduce((e,t)=>e+(parseFloat(t.quantity)||0),0)),R=b(()=>a.items.reduce((e,t)=>e+(parseFloat(t.subtotal)||0),0));return{form:a,searchResults:r,isLoadingSearch:p,addItem:I,removeItem:C,handleSearch:A,calculateSubtotal:x,calculateQty:D,checkIntegerInput:S,isDecimalAllowed:g,formatCurrency:F,totalQty:_,grandTotal:R,hasInvalidQty:f,hasStockError:h,submitForm:y}}const te={class:"flex flex-col h-screen overflow-hidden bg-gray-50"},se={class:"relative z-20 flex flex-col items-center justify-between flex-shrink-0 gap-4 px-6 py-4 bg-white border-b border-gray-200 shadow-sm md:flex-row"},ae={class:"flex items-center flex-1 w-full gap-4"},oe={class:"w-40"},re={class:"flex-1"},ne={class:"flex items-center justify-between order-2 w-full h-auto gap-2 px-0 py-2 mt-2 border-l-0 border-r border-gray-200 rounded md:flex-row md:gap-8 md:px-8 md:border-l md:h-12 md:w-auto md:justify-start md:py-0 md:order-none bg-gray-50 md:bg-transparent md:rounded-none md:mt-0"},le={class:"flex-1 text-center md:flex-none"},ie={class:"text-base font-bold leading-none text-gray-700 md:text-lg"},de={class:"flex-1 pl-2 text-center border-l border-gray-200 md:flex-none md:border-0 md:pl-0"},ce={class:"text-base font-bold leading-none text-gray-700 md:text-lg"},me={class:"order-1 w-full text-right md:w-auto md:order-none"},ue={class:"text-2xl font-black leading-none tracking-tight text-indigo-600 md:text-3xl"},pe={class:"relative flex flex-col flex-1 min-h-0"},ge={class:"z-10 p-4 pb-0"},fe={class:"flex flex-col flex-1 p-4 pt-2 overflow-hidden"},he={class:"z-20 flex justify-end flex-shrink-0 gap-3 p-4 bg-white border-t border-gray-200"},xe={key:0,class:"w-5 h-5 text-white animate-spin",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},ye={key:1},_e={key:2},Ae={__name:"form",props:{sale:Object,mode:String},setup(i){const d=i;M();const{isActionLoading:m}=X(),a=j(null),{form:r,grandTotal:p,totalQty:w,formatCurrency:g,handleSearch:S,searchResults:F,isLoadingSearch:f,addItem:h,removeItem:I,checkIntegerInput:C,isDecimalAllowed:x,calculateSubtotal:D,calculateQty:A,hasInvalidQty:y,hasStockError:_,submitForm:R}=ee(d);return console.log(r),m.value=r.processing,(e,t)=>(v(),k(K,null,[c(s(P),{title:"Input Rekap Penjualan"}),c(Z,{showHeader:!1,showSidebar:!1},{default:q(()=>[o("div",te,[o("div",se,[o("div",ae,[o("div",oe,[c(L,{value:"Tanggal Laporan",class:"mb-1 text-xs font-bold text-gray-500 uppercase"}),Q(o("input",{type:"date","onUpdate:modelValue":t[0]||(t[0]=l=>s(r).report_date=l),class:"w-full text-sm font-bold border-gray-300 rounded focus:ring-indigo-500"},null,512),[[T,s(r).report_date]])]),o("div",re,[c(L,{value:"Catatan",class:"mb-1 text-xs font-bold text-gray-500 uppercase"}),Q(o("input",{type:"text","onUpdate:modelValue":t[1]||(t[1]=l=>s(r).notes=l),class:"w-full text-sm border-gray-300 rounded focus:ring-indigo-500",placeholder:"Shift pagi, cuaca hujan..."},null,512),[[T,s(r).notes]])])]),o("div",ne,[o("div",le,[t[2]||(t[2]=o("div",{class:"text-[9px] md:text-[10px] text-gray-400 uppercase font-bold tracking-wider"}," Item ",-1)),o("div",ie,E(s(r).items.length),1)]),o("div",de,[t[3]||(t[3]=o("div",{class:"text-[9px] md:text-[10px] text-gray-400 uppercase font-bold tracking-wider"}," Qty ",-1)),o("div",ce,E(s(w)),1)])]),o("div",me,[t[4]||(t[4]=o("div",{class:"text-[10px] text-gray-400 uppercase tracking-widest font-bold mb-1"}," Estimasi Omset ",-1)),o("div",ue,E(s(g)(s(p))),1)])]),o("div",pe,[o("div",ge,[c(Y,{ref_key:"productSearchRef",ref:a,"search-results":s(F),"is-loading":s(f),onSearch:s(S),onAdd:s(h)},null,8,["search-results","is-loading","onSearch","onAdd"])]),o("div",fe,[c(W,{items:s(r).items,"is-decimal-allowed":s(x),"check-integer":s(C),onRemove:s(I),onUpdateCalc:s(D),onUpdateQty:s(A)},null,8,["items","is-decimal-allowed","check-integer","onRemove","onUpdateCalc","onUpdateQty"])]),o("div",he,[c(s(U),{href:e.route("sales.index"),class:"px-6 py-3 text-sm font-medium text-gray-700 transition bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"},{default:q(()=>[...t[5]||(t[5]=[$(" Kembali ",-1)])]),_:1},8,["href"]),c(H,{disabled:s(r).items.length===0||s(r).processing||s(y)||s(_),class:B([{"opacity-50  cursor-not-allowed":s(r).items.length===0||s(r).processing||s(y)||s(_)},"flex items-center gap-2 px-8 py-3 text-base shadow-lg"]),onClick:s(R)},{default:q(()=>[s(r).processing?(v(),k("svg",xe,[...t[6]||(t[6]=[o("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),o("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):G("",!0),s(r).processing?(v(),k("span",ye,"Menyimpan...")):(v(),k("span",_e,"Simpan Rekap"))]),_:1},8,["disabled","class","onClick"])])])])]),_:1})],64))}};export{Ae as default};
