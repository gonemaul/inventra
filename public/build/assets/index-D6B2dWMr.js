import{q as pe,v as r,D as k,u as fe,K as ee,x as ye,a as me,l as ie,o as V,e as x,d as ve,p as ue,f as i,g as n,i as he,t as ce,k as be,F as _e}from"./vendor-core-By7Plnkm.js";import{j as ke}from"./vendor-common-GpUWqhKr.js";import xe from"./ConfirmSubmit-mjedVv3P.js";import we from"./Cart-DjZlvKin.js";import{_ as Se}from"./BarcodeScanner-DKRXhBOH.js";import Ce from"./FilterProduct-CLECiUK2.js";import Fe from"./ProductDetailModal-BqI2Y1FV.js";import qe from"./ProductComparisonModal-Br3KQz45.js";import Me from"./TransactionSuccessModal-DY09UpZR.js";import Te from"./ProductList-DjiML4g8.js";import Pe from"./PosQtyModal--xmYIGFs.js";import"./vendor-charts-Bw6UNgWf.js";import"./BottomSheet-WceNnWH3.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./InputRupiah-BO9l6Y_n.js";import"./MoneyInput-BgfUFfy0.js";import"./vendor-scanner-og__AIM6.js";function Ae(v){const g=pe(),C="POS_REALTIME_DRAFT_V3",d=r([]),l=r(!1),I=r(20),h=r(!0),f=r({search:"",category:"all",subCategory:"all",brand:"all",sort:"default",hideEmptyStock:!0}),y=r([]),R=r(""),F=r([]),q=r(null),U=r([]),O=k(()=>v.mode==="edit"),u=v.sale||null,s=fe({id:u?.id||null,input_type:u?.input_type||"realtime",report_date:u?.transaction_date||(()=>{const e=new Date,a=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${a}-${t}-${o}`})(),items:u?.items?.map(e=>{const a=e.product,t=e.product_snapshot||{},o=a?.name||t.name||"Unknown Item",p=a?.code||t.code||"-";let c=a?.category;return!c&&t.category&&(c={name:t.category}),{product_id:e.product_id,code:p,name:o,category:c,unit:a?.unit||(t.unit?{name:t.unit}:null),size:a?.size,stock_max:parseFloat(a?.stock||0)+parseFloat(e.quantity),selling_price:parseFloat(e.selling_price),original_price:parseFloat(e.selling_price),quantity:parseFloat(e.quantity),original_quantity:parseFloat(e.quantity),subtotal:parseFloat(e.subtotal)}})||[],customer_id:u?.customer_id||null,payment_amount:u?parseFloat(u.total_payment):0,change_amount:u?parseFloat(u.change_amount):0,payment_method:u?.payment_method||"cash",discount_type:u?.discount_type||"fixed",discount_value:u?.discount_value||0,notes:u?.notes||""}),M=k(()=>s.items.reduce((e,a)=>e+(parseFloat(a.subtotal)||0),0)),J=k(()=>{const e=parseFloat(s.discount_value)||0;if(e<=0)return 0;if(s.discount_type==="percent"){const a=e>100?100:e;return Math.round(M.value*a/100)}return e>M.value?M.value:e}),T=k(()=>{const e=M.value-J.value,a=e>0?e:0;return a===0&&s.payment_amount>0,a}),K=k(()=>(parseFloat(s.payment_amount)||0)-T.value),H=k(()=>s.payment_method!=="cash"&&s.payment_method!==""?!0:(parseFloat(s.payment_amount)||0)>=T.value),Y=k(()=>s.items.some(e=>e.quantity<=0||isNaN(e.quantity))),de=k(()=>{const e=T.value;if(e<=0)return[];const a=[{label:"Uang Pas",value:e}];if([2e3,5e3,1e4,2e4,5e4,1e5].forEach(o=>{o>e&&!a.find(p=>p.value===o)&&a.push({label:D(o),value:o})}),e>5e4){const o=Math.ceil(e/5e4)*5e4;a.find(p=>p.value===o)||a.push({label:D(o),value:o})}return a.slice(0,4)}),b=e=>{e.unit?.is_decimal===1||(e.quantity=Math.round(e.quantity),e.quantity<1&&(e.quantity=1)),e.quantity>e.stock_max&&(e.quantity=e.stock_max,g.warning(`Stok sisa ${e.stock_max}`)),e.subtotal=Math.round(e.quantity*e.selling_price)},te=e=>{const a=parseFloat(e.subtotal)||0,t=parseFloat(e.selling_price)||0;if(!(t<=0))if(e.unit?.is_decimal===1){let o=a/t;o>e.stock_max&&(o=e.stock_max,e.subtotal=Math.round(o*t),g.warning("Melebihi sisa stok!")),e.quantity=parseFloat(o.toFixed(4))}else confirm(`⚠️ Ubah harga satuan agar sesuai total ${D(a)}?`)?e.quantity>0&&(e.selling_price=Math.round(a/e.quantity)):e.subtotal=Math.round(e.quantity*e.selling_price)},$=e=>{e.subtotal=Math.round(e.quantity*e.selling_price)},P=e=>{const a=["Jasa","Layanan"].includes(e.category?.name);if(!a&&parseFloat(e.stock)<=0){g.error("Stok habis!");return}const t=s.items.find(o=>o.product_id===e.id);if(t){if(a){g.warning(`Jasa "${e.name}" sudah ada di keranjang.`);return}if(t.quantity+1>e.stock){g.warning("Stok maksimal!");return}t.quantity++,b(t)}else{const o=parseFloat(e.selling_price||e.price);s.items.push({product_id:e.id,code:e.code,name:e.name,image_url:e.image_url,category:e.category,unit:e.unit,size:e.size,stock_max:parseFloat(e.stock),selling_price:o,original_price:o,quantity:1,original_quantity:0,subtotal:o,is_service:a})}},A=e=>s.items.splice(e,1),j=(e,a)=>{const t=s.items[e],o=parseFloat(t.quantity)+a;if(o>t.stock_max){g.warning(`Stok sisa ${t.stock_max}`);return}if(o<=0){confirm("Hapus item ini?")&&A(e);return}t.quantity=o,b(t)},E=e=>{s.payment_amount=e.value},z=()=>{s.payment_amount=0},L=()=>{d.value.length&&s.items.forEach(e=>{const a=d.value.find(t=>t.id===e.product_id);if(a){const t=e.original_quantity||0,o=parseFloat(a.stock);e.stock_max=o+t,e.quantity>e.stock_max&&(g.warning(`Stok ${e.name} berubah! Disesuaikan ke max: ${e.stock_max}`),e.quantity=e.stock_max,b(e))}})},w=r(new Map),_=r([]),N=r([]),S=async(e={})=>{const a=I.value,t=e.search||f.value.search,o={query:t,limit:a,category_id:t?"all":f.value.category,product_type_id:t?"all":f.value.subCategory,brand_id:t?"all":f.value.brand,sort:f.value.sort,hide_empty_stock:f.value.hideEmptyStock?1:0,size_id:t?"all":f.value.size||"all"},p=JSON.stringify(o);if(w.value.has(p)){const c=w.value.get(p);Array.isArray(c)?d.value=c:(d.value=c.products,_.value=c.available_brands||[],N.value=c.available_sizes||[],c.products.length<a?h.value=!1:h.value=!0),L()}else l.value=!0;try{const m=(await me.get(route("sales.products.lite"),{params:o})).data;let Q=[];Array.isArray(m)?Q=m:(Q=m.products,_.value=m.available_brands||[],N.value=m.available_sizes||[]),d.value=Q,Q.length<a?h.value=!1:h.value=!0,w.value.set(p,m),L()}catch(c){console.error("Gagal load produk:",c),w.value.has(p)||g.error("Gagal memuat database produk")}finally{l.value=!1}},B=ke(()=>{I.value=20,h.value=!0,S()},400);ee(()=>f.value,(e,a)=>{e.search!==a.search?(l.value=!0,B()):((e.category!==a.category||e.subCategory!==a.subCategory||e.brand!==a.brand)&&(I.value=20,h.value=!0,d.value=[]),S())},{deep:!0});const G=k(()=>d.value),ae=()=>{!h.value||l.value||(I.value+=12,S())},oe=async()=>{try{const e=await me.get(route("sales.products.lite"),{params:{only_services:!0,limit:100}});e.data.products?U.value=e.data.products:Array.isArray(e.data)?U.value=e.data:U.value=[]}catch(e){console.error("Gagal load layanan:",e)}},W=e=>{q.value=e,s.customer_id=e.id,F.value=[],R.value=""};ee(R,e=>{if(!e||!v.customers){F.value=[];return}const a=e.toLowerCase(),t=v.customers.filter(o=>o.name.toLowerCase().includes(a)||o.code.toLowerCase().includes(a));F.value=t.slice(0,5)});const se=e=>{const a=v.customers.find(t=>t.member_code==e||t.phone==e);a?W(a):g.warning("Member tidak ditemukan")},ne=()=>{if(O.value)return;const e=localStorage.getItem(C);if(e)try{const a=JSON.parse(e);a.items&&(s.items=a.items),s.payment_amount=a.payment_amount||0,s.payment_method=a.payment_method||"cash",s.notes=a.notes||"",s.discount_type=a.discount_type||"fixed",s.discount_value=a.discount_value||0,a.selectedMember&&(q.value=a.selectedMember,s.customer_id=a.selectedMember.id)}catch{localStorage.removeItem(C)}};ee([()=>s.items,()=>s.customer_id,()=>s.payment_amount,()=>s.discount_value,()=>s.notes],()=>{localStorage.setItem(C,JSON.stringify({items:s.items,customer_id:s.customer_id,payment_amount:s.payment_amount,payment_method:s.payment_method,notes:s.notes,discount_type:s.discount_type,discount_value:s.discount_value,selectedMember:q.value}))},{deep:!0});const re=(e=!1)=>new Promise((a,t)=>{const o=K.value,p=T.value;s.change_amount=o,s.payment_amount=parseFloat(s.payment_amount);const c={onSuccess:m=>{const ge=(m.props.flash||{}).sale_id;O.value||(S(),localStorage.removeItem(C),s.reset(),s.items=[],q.value=null),a({success:!0,saleId:ge,change:o,total:p})},onError:m=>{console.error(m),g.error("Gagal memproses transaksi"),t(m)},onFinish:()=>{}};O.value?s.transform(m=>({...m})).put(route("sales.update",s.id),c):s.transform(m=>({...m,print_invoice:e})).post(route("sales.pos.store"),c)}),D=e=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(e),X=e=>{const a=y.value.findIndex(t=>t.id===e.id);if(a!==-1)y.value.splice(a,1);else{if(y.value.length>=5){g.warning("Maksimal 5 produk untuk perbandingan.");return}y.value.push(e)}},Z=()=>{y.value=[]},le=e=>y.value.some(a=>a.id===e);return ye(()=>{if(S(),oe(),ne(),O.value){const e=new Date().toISOString().slice(0,10);s.report_date=e}}),{form:s,filterState:f,allProducts:d,filteredProducts:G,isFetchingData:l,compareList:y,serviceProducts:U,dynamicBrands:_,dynamicSizes:N,memberSearch:R,memberSearchResults:F,selectedMember:q,subTotal:M,discountAmount:J,grandTotal:T,changeAmount:K,isPaymentSufficient:H,hasInvalidQty:Y,moneySuggestions:de,loadMoreProducts:ae,queryMember:se,addItem:P,removeItem:A,updateQty:j,resetPayment:z,handleMoneyClick:E,recalcFromQty:b,recalcFromSubtotal:te,recalcFromPrice:$,toggleCompare:X,clearCompare:Z,isInCompare:le,submitTransaction:re,rp:D}}const De={class:"flex flex-col lg:flex-row h-[100dvh] w-full bg-gray-100 dark:bg-gray-900 overflow-hidden font-sans transition-colors duration-300"},Ie={class:"relative flex flex-col flex-1 h-full overflow-hidden"},$e={key:0,class:"absolute z-40 bottom-24 lg:bottom-8 right-4 flex items-center bg-gray-900 dark:bg-gray-800 text-white pl-4 pr-1 py-1.5 gap-4 rounded-full shadow-xl animate-bounce-subtle border border-gray-700"},Ee={class:"text-xs font-bold whitespace-nowrap"},ze={class:"flex items-center gap-1"},Le={key:1,class:"absolute z-30 lg:hidden bottom-4 left-4 right-4"},Ne={class:"flex items-center gap-3"},Be={class:"flex items-center justify-center text-xs font-bold text-white rounded-full shadow-sm bg-lime-500 dark:bg-white dark:text-lime-700 w-7 h-7"},Re={class:"flex flex-col items-start leading-none gap-0.5"},Ue={class:"text-lg font-bold"},nt={__name:"index",props:{categories:Array,customers:Array,brands:Array,sale:Object,mode:String},setup(v){const C=Ae(v),{form:d,filterState:l,allProducts:I,filteredProducts:h,isFetchingData:f,dynamicBrands:y,dynamicSizes:R,grandTotal:F,changeAmount:q,isPaymentSufficient:U,hasInvalidQty:O,addItem:u,loadMoreProducts:s,queryProduk:M,queryMember:J,submitTransaction:T,rp:K,toggleCompare:H,clearCompare:Y,isInCompare:de,compareList:b}=C,te=pe(),$=r(!1),P=r(!1),A=r(!1),j=r(!1),E=r(!1),z=r(!1),L=r(!1),w=r(!1),_=r("product"),N=r(null);r(null),ee(l,async()=>{},{deep:!0});const S=()=>{j.value=!1,d.reset(),d.items=[]},B=r({id:null,name:"",code:"",price:0,quantity:1,stock:0,unit:"Pcs",image:null}),G=a=>{B.value={id:a.id,name:a.name,code:a.code,image_url:a.image_url,price:parseFloat(a.selling_price||a.price||0),quantity:1,stock:parseInt(a.stock||0),unit:a.unit?.name||"Pcs"},z.value=!0},ae=a=>{const t={id:a.id,name:a.name,code:a.code,image_url:a.image_url,price:parseFloat(a.selling_price||a.price||0),quantity:1,stock:parseInt(a.stock||0),unit:a.unit?.name||"Pcs"};u(t)},oe=a=>{N.value=a,L.value=!0},W=()=>{_.value="product",P.value=!0},se=()=>{_.value="member",P.value=!0},ne=async a=>{if(P.value=!1,alert("scan berhasil "+_.value+" | "+a),_.value=="product")try{const t=await M(a);t?(a=t,G(a)):alert("Produk tidak ditemukan di database.")}catch(t){console.error("Terjadi kesalahan saat query produk:",t),alert("Gagal mengambil data produk.")}else _.value=="member"&&(a=J(a))},re=(a=!1)=>{u(B.value),z.value=!1,a&&W()},D=r(0),X=r(0),Z=r(null),le=a=>{E.value=!0,T(a).then(t=>{E.value=!1,A.value=!1,t.success?(D.value=t.change,X.value=t.total,j.value=!0,Z.value?.resetStep(),$.value=!1):te.success("Transaksi berhasil disimpan.")}).catch(t=>{console.error("Error submitting transaction:",t),E.value=!1})},e=()=>{document.activeElement&&["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&document.activeElement.blur()};return(a,t)=>(V(),ie(_e,null,[x(n(he),{title:"Kasir POS"}),x(Fe,{show:L.value,product:N.value,onClose:t[0]||(t[0]=o=>L.value=!1),onAddToCart:t[1]||(t[1]=o=>{G(o)})},null,8,["show","product"]),x(qe,{show:w.value,products:n(b),onClose:t[2]||(t[2]=o=>w.value=!1),onRemove:n(H),onAddToCart:t[3]||(t[3]=o=>{G(o)})},null,8,["show","products","onRemove"]),P.value?(V(),ve(Se,{key:0,onResult:ne,onClose:t[4]||(t[4]=o=>P.value=!1)})):ue("",!0),i("div",De,[i("div",Ie,[x(Ce,{categories:v.categories,brands:n(y)?.length?n(y):v.brands,sizes:n(R),"is-fetching":n(f),search:n(l).search,"onUpdate:search":t[5]||(t[5]=o=>n(l).search=o),category:n(l).category,"onUpdate:category":t[6]||(t[6]=o=>n(l).category=o),subCategory:n(l).subCategory,"onUpdate:subCategory":t[7]||(t[7]=o=>n(l).subCategory=o),brand:n(l).brand,"onUpdate:brand":t[8]||(t[8]=o=>n(l).brand=o),size:n(l).size,"onUpdate:size":t[9]||(t[9]=o=>n(l).size=o),sort:n(l).sort,"onUpdate:sort":t[10]||(t[10]=o=>n(l).sort=o),hideEmptyStock:n(l).hideEmptyStock,"onUpdate:hideEmptyStock":t[11]||(t[11]=o=>n(l).hideEmptyStock=o),onScan:W},null,8,["categories","brands","sizes","is-fetching","search","category","subCategory","brand","size","sort","hideEmptyStock"]),x(Te,{products:n(h),"is-fetching":n(f),"cart-items":n(d).items,"all-products-count":n(I).length,"compare-list":n(b),onLoadMore:n(s),onAddToCart:ae,onOpenDetail:oe,onToggleCompare:n(H),onScrollList:e},null,8,["products","is-fetching","cart-items","all-products-count","compare-list","onLoadMore","onToggleCompare"]),n(b)?.length>0?(V(),ie("div",$e,[i("div",Ee,ce(n(b).length)+" Banding ",1),i("div",ze,[i("button",{onClick:t[12]||(t[12]=o=>w.value=!0),class:"px-3 py-1.5 bg-lime-500 hover:bg-lime-400 text-black text-xs font-bold rounded-full transition"}," Buka "),i("button",{onClick:t[13]||(t[13]=(...o)=>n(Y)&&n(Y)(...o)),class:"p-1.5 hover:bg-gray-700 rounded-full text-gray-400 hover:text-white transition"},[...t[20]||(t[20]=[i("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[i("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])])])):ue("",!0),n(d).items.length>0?(V(),ie("div",Le,[i("button",{onClick:t[14]||(t[14]=o=>$.value=!0),class:"w-full bg-gray-900 dark:bg-lime-600 text-white p-3.5 rounded-2xl shadow-xl shadow-gray-900/20 flex justify-between items-center animate-bounce-subtle"},[i("div",Ne,[i("span",Be,ce(n(d).items.reduce((o,p)=>o+parseFloat(p.quantity),0)),1),i("div",Re,[t[21]||(t[21]=i("span",{class:"text-[9px] text-gray-400 dark:text-lime-100 uppercase font-bold tracking-wider"},"Total Belanja",-1)),i("span",Ue,ce(n(K)(n(F))),1)])]),t[22]||(t[22]=i("span",{class:"flex items-center gap-1 px-4 py-2 text-xs font-bold bg-gray-700 dark:bg-lime-800/30 rounded-xl"},[be(" Bayar "),i("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[i("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M14 5l7 7m0 0l-7 7m7-7H3"})])],-1))])])):ue("",!0)]),x(we,{ref_key:"cartRef",ref:Z,showMobileCart:$.value,reprops:n(C),onOpenScanMember:se,onShowBayar:t[15]||(t[15]=o=>A.value=!0),onShowDesktop:t[16]||(t[16]=o=>$.value=!1)},null,8,["showMobileCart","reprops"])]),x(Pe,{show:z.value,item:B.value,"onUpdate:item":t[17]||(t[17]=o=>B.value=o),onClose:t[18]||(t[18]=o=>z.value=!1),onAddToCart:re},null,8,["show","item"]),x(xe,{showConfirmModal:A.value,changeAmount:n(q),grandTotal:n(F),paymentAmount:parseFloat(n(d).payment_amount),processing:E.value,onClose:t[19]||(t[19]=o=>A.value=!1),onConfirmTransaction:le},null,8,["showConfirmModal","changeAmount","grandTotal","paymentAmount","processing"]),x(Me,{show:j.value,changeAmount:D.value,total:X.value,onClose:S,onNewTransaction:S},null,8,["show","changeAmount","total"])],64))}};export{nt as default};
