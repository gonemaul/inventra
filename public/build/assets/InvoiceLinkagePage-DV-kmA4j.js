import{x as te,s as m,j as U,u as T,G as se,y as ae,g as i,o as n,a as f,d as oe,h as le,w as j,b as e,q as _,f as x,i as b,e as V,F as $,m as H,t as l,k as C,n as D,z as O,v as K}from"./app-C_cXePOB.js";import{_ as ie}from"./AuthenticatedLayout-DqzYp9rK.js";import{P as E}from"./PrimaryButton-D5q8Vryj.js";import{_ as ne}from"./SecondaryButton-ClbDvNQj.js";import{_ as re}from"./ImageModal-DbaHFI2H.js";import{u as de}from"./useActionLoading-Bvh_DZn-.js";import{l as ue}from"./lodash-B17NO2GL.js";import ce from"./search-n1wGpV__.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./Modal-DR4Qf9lZ.js";import"./TextInput-PROtXgwY.js";const me={class:"flex items-center justify-between mb-4"},pe={class:"grid grid-cols-1 gap-6 lg:grid-cols-3"},ve={class:"space-y-6 lg:col-span-2"},ge={class:"p-6 bg-white border-2 border-gray-100 rounded-lg shadow-lg dark:bg-gray-800"},he={key:0,class:"py-8 text-center text-gray-500"},be={key:0,class:"overflow-x-auto max-h-[55vh] border rounded dark:border-gray-700 mb-4"},ke={class:"min-w-full text-sm"},ye={class:"sticky top-0 bg-gray-50 dark:bg-gray-700"},fe={key:0,class:"w-16 px-2 py-2 text-center"},xe={class:"px-4 py-2"},_e={class:"flex flex-col"},we={class:"font-bold text-gray-800 dark:text-white"},Ie={class:"text-xs text-gray-500"},Se={class:"text-xs text-gray-400"},Te={class:"w-1/12 px-2 py-2 text-center"},je=["onUpdate:modelValue","disabled"],Ce={class:"w-1/6 px-2 py-2 text-right"},Fe={class:"flex gap-2"},Ne=["onUpdate:modelValue","disabled"],Le={class:"px-2 py-2 text-center"},Pe=["value"],Ue={key:1,class:"flex items-center justify-between pt-4"},Ve=["disabled"],$e={class:"space-y-6 lg:col-span-1"},De={class:"p-4 border-2 rounded-lg shadow-lg border-lime-100 bg-lime-50 dark:bg-lime-900/30"},Be={class:"flex justify-between mb-2 text-lg font-bold text-yellow-800 dark:text-yellow-200"},Qe={class:"text-sm dark:text-gray-300"},qe={class:"flex justify-between pb-2 mb-1 border-b-2 border-lime-300"},Me={class:"flex flex-col"},He={class:"font-medium"},Oe={class:"text-sm text-gray-500"},Ke={class:"flex justify-between"},Ee={class:"text-xl font-extrabold text-red-600"},Je={class:"flex justify-between"},Re={class:"font-bold text-green-700"},ze={class:"flex justify-between"},Ae={class:"font-bold text-green-700"},Ge={class:"flex justify-between"},We={class:"flex justify-between"},Xe={key:0,class:"mt-3"},Ye=["src"],Ze={key:0,class:"p-4 border-2 rounded-lg shadow-lg border-lime-100 bg-lime-50 dark:bg-lime-900/30"},et={key:1,class:"p-6 bg-white border-2 border-gray-100 rounded-lg shadow-lg dark:bg-gray-800"},tt={key:0,class:"py-4 text-center text-gray-500"},st={key:1,class:"overflow-y-auto border rounded max-h-48 dark:border-gray-700"},at={class:"p-2 space-y-1"},ot=["for"],lt=["id","value"],it={class:"flex flex-col flex-1"},nt={class:"font-medium text-gray-900 dark:text-white"},rt={class:"flex items-center justify-between mt-1 text-xs"},dt={class:"text-gray-600 dark:text-gray-400"},ut={class:"font-bold text-gray-800 dark:text-gray-200"},ct={key:2,class:"flex justify-end mt-4"},wt={__name:"InvoiceLinkagePage",props:{purchase:Object,invoice:Object,unlinkedItems:Object,linkedItems:Object,products:{type:Array,default:()=>[]}},setup(a){const d=a,{isActionLoading:v}=de(),c=te(),u=m(!1),p=U(()=>d.purchase.status==="checking"?"edit":"detail"),g=m([]),h=m([]),k=m([]),J=m(!1),y=m(""),w=m([]),F=m(!1),I=T({ids:[],type:"link"}),N=T({product_id:[],type:"create"}),L=T({item_ids:[]}),B=T({items:g});se(()=>{g.value=JSON.parse(JSON.stringify(d.linkedItems))});const S=o=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(o),Q=o=>o?new Date(o).toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"}):"-",R=()=>_.get(route("purchases.checking",d.purchase.id)),z=U(()=>g.value.reduce((o,t)=>{const s=(t.quantity||0)*(t.purchase_price||0);return o+s},0)),A=U(()=>g.value.reduce((o,t)=>o+(t.quantity||0),0)),P=m(!1),q=m(null),M=m(null),G=(o,t)=>{q.value=o,M.value="Invoice-#"+t,P.value=!0},W=()=>{if(h.value.length===0){c.error("Pilih minimal satu item untuk ditautkan.");return}I.ids=[],I.ids=h.value,console.log(I.ids),v.value=!0,u.value=!0,I.post(route("purchases.linkItems",{purchase:d.purchase.id,invoice:d.invoice.id}),{preserveScroll:!0,onSuccess:()=>{c.success(`${h.value.length} item berhasil ditautkan. Harga otomatis diperbarui.`),_.visit(window.location.href,{preserveScroll:!0,preserveState:!1})},onError:o=>{c.success(`Terdapat kesalahan : ${o}`),console.log(o)},onFinish:()=>{u.value=!1,v.value=!1,h.value=[]}})},X=()=>{if(k.value.length===0){c.error("Pilih minimal satu item untuk dilepaskan.");return}L.item_ids=[],L.item_ids=k.value,v.value=!0,u.value=!0,L.put(route("purchases.unlinkItems",{purchase:d.purchase.id,invoice:d.invoice.id}),{preserveScroll:!0,onSuccess:()=>{c.warning(`${k.value.length} item dilepaskan. Harga item lain tidak berubah.`),_.visit(window.location.href,{preserveScroll:!0,preserveState:!1})},onFinish:()=>{u.value=!1,v.value=!1,k.value=[]}})},Y=()=>{if(v.value=!0,u.value=!0,g.value.some(t=>t.quantity<0)){c.error("Kuantitas yang diterima tidak boleh kurang dari nol."),u.value=!1,v.value=!1;return}B.items=g.value,B.put(route("purchases.updateLinkedItemDetails",{purchase:d.purchase.id,invoice:d.invoice.id}),{preserveScroll:!0,onSuccess:()=>{c.success(`${g.value.length} Produk berhasil diperbarui!`),_.reload({only:["linkedItems"]})},onFinish:()=>{u.value=!1,v.value=!1}})},Z=ue.throttle(()=>{if(y.value.length<2){w.value=[];return}F.value=!0,w.value=d.products.filter(o=>o.name.toLowerCase().includes(y.value.toLowerCase())||o.code.toLowerCase().includes(y.value.toLowerCase())).slice(0,5),F.value=!1},300);ae(y,Z);const ee=o=>{const t=g.value.some(r=>r.product_id===o.id),s=unlinkedItems.value.some(r=>r.product_id===o.id);if(t){c.warning("Produk ini sudah ada di daftar. Gunakan input Qty untuk menambah.");return}if(s){c.warning("Produk ini sudah ada di daftar pembelian. Tautkan untuk menambahkan ke invoice.");return}N.product_id=[],N.product_id=[o.id],v.value=!0,u.value=!0,N.post(route("purchases.linkItems",{purchase:d.purchase.id,invoice:d.invoice.id}),{preserveScroll:!0,onSuccess:()=>{c.success("Produk berhasil ditambahkan kedalam Invoice"),_.visit(window.location.href,{preserveScroll:!0,preserveState:!1})},onError:r=>{c.success(`Terdapat kesalahan : ${r}`),console.log(r)},onFinish:()=>{u.value=!1,v.value=!1,h.value=[]}}),y.value="",w.value=[],J.value=!1};return(o,t)=>(n(),i($,null,[f(re,{show:P.value,imageUrl:q.value,productName:M.value,onClose:t[0]||(t[0]=s=>P.value=!1)},null,8,["show","imageUrl","productName"]),f(oe(le),{title:`Invoice #${a.invoice.invoice_number}`},null,8,["title"]),f(ie,{headerTitle:`Invoice : #${a.invoice.invoice_number}`,showSidebar:!1},{default:j(()=>[e("div",me,[f(ne,{onClick:R},{default:j(()=>[...t[5]||(t[5]=[x(" â† Kembali ke Validasi Utama ",-1)])]),_:1})]),e("div",pe,[e("div",ve,[e("div",ge,[t[11]||(t[11]=e("h3",{class:"pb-2 mb-4 text-xl font-bold border-b dark:text-gray-200"}," Koreksi Qty Diterima & Harga Final ",-1)),a.linkedItems.length===0?(n(),i("p",he," Belum ada produk tertaut ke nota ini. Tautkan item dari daftar kanan. ")):b("",!0),e("form",{onSubmit:V(Y,["prevent"])},[a.linkedItems.length>0?(n(),i("div",be,[e("table",ke,[e("thead",ye,[e("tr",null,[t[6]||(t[6]=e("th",{class:"px-4 py-2 text-left"}," Produk ",-1)),t[7]||(t[7]=e("th",{class:"w-20 px-2 py-2 text-center"}," Qty Datang ",-1)),t[8]||(t[8]=e("th",{class:"w-24 px-2 py-2 text-right"}," Harga Final ",-1)),p.value.value==="edit"?(n(),i("th",fe," Unlink ")):b("",!0)])]),e("tbody",null,[(n(!0),i($,null,H(g.value,s=>(n(),i("tr",{key:s.id,class:"hover:bg-gray-50 dark:hover:bg-gray-700"},[e("td",xe,[e("div",_e,[e("span",we,l(s.product_snapshot.name),1),e("span",Ie,l(s.product_snapshot.brand)+" | "+l(s.product_snapshot.code)+" | "+l(s.product_snapshot.category),1),e("span",Se,l(s.product_snapshot.size)+" - "+l(s.product_snapshot.unit),1)])]),e("td",Te,[C(e("input",{"onUpdate:modelValue":r=>s.quantity=r,type:"number",disabled:p.value!=="edit",class:D([{"opacity-50 cursor-not-allowed":p.value!=="edit"},"w-full px-2 py-1 text-sm text-center border rounded dark:text-gray-800"]),min:"0"},null,10,je),[[O,s.quantity,void 0,{number:!0}]])]),e("td",Ce,[e("span",Fe,[t[9]||(t[9]=x(" Rp ",-1)),C(e("input",{"onUpdate:modelValue":r=>s.purchase_price=r,type:"number",disabled:p.value!=="edit",class:D([{"opacity-50 cursor-not-allowed":p.value!=="edit"},"w-full px-1 py-1 text-sm text-right border rounded dark:text-gray-800"]),min:"0"},null,10,Ne),[[O,s.purchase_price,void 0,{number:!0}]])])]),e("td",Le,[p.value==="edit"?C((n(),i("input",{key:0,type:"checkbox",value:s.id,"onUpdate:modelValue":t[1]||(t[1]=r=>k.value=r),class:"text-red-600 rounded"},null,8,Pe)),[[K,k.value]]):b("",!0)])]))),128))])])])):b("",!0),p.value==="edit"?(n(),i("div",Ue,[f(E,{class:"dark:bg-lime-500 dark:hover:bg-lime-700",type:"submit",disabled:u.value,title:"Simpan perubahan Qty dan Harga"},{default:j(()=>[...t[10]||(t[10]=[x(" Simpan Koreksi Harga/Qty ",-1)])]),_:1},8,["disabled"]),e("button",{onClick:V(X,["prevent"]),disabled:k.value.length===0||u.value,class:"px-4 py-2 text-xs font-semibold tracking-widest text-white uppercase transition duration-150 ease-in-out bg-red-500 rounded-md hover:bg-red-600"}," Lepaskan "+l(k.value.length)+" Item ",9,Ve)])):b("",!0)],32)])]),e("div",$e,[e("div",De,[e("h3",Be,[t[12]||(t[12]=x(" Detail Nota Target ",-1)),e("span",{class:D([{"px-2 py-1 text-white rounded":!0,"bg-green-600":a.invoice.payment_status==="paid","bg-yellow-600":a.invoice.payment_status==="partial","bg-red-600":a.invoice.payment_status==="unpaid"},"items-center text-xs uppercase"])},l(a.invoice.payment_status),3)]),e("div",Qe,[e("p",qe,[t[13]||(t[13]=e("strong",null,"Supplier : ",-1)),e("div",Me,[e("span",He,l(a.purchase.supplier?a.purchase.supplier.name:"Umum/Cash"),1),e("span",Oe,l(a.purchase.supplier?a.purchase.supplier.address+" | "+a.purchase.supplier.phone:"-"),1)])]),e("p",Ke,[t[14]||(t[14]=e("strong",null,"Total Nominal Nota:",-1)),e("span",Ee,l(S(a.invoice.total_amount)),1)]),e("p",Je,[t[15]||(t[15]=e("strong",null,"Subtotal Produk ditautkan :",-1)),e("span",Re,l(S(z.value)),1)]),e("p",ze,[t[16]||(t[16]=e("strong",null,"Jumlah Produk ditautkan :",-1)),e("span",Ae,l(A.value),1)]),e("p",Ge,[t[17]||(t[17]=x(" Diterbitkan pada : ",-1)),e("span",null,l(Q(a.invoice.invoice_date)),1)]),e("p",We,[t[18]||(t[18]=x(" Jatuh Tempo pada : ",-1)),e("span",null,l(Q(a.invoice.due_date)),1)])]),a.invoice.invoice_image?(n(),i("div",Xe,[t[19]||(t[19]=e("p",{class:"mb-1 text-xs font-semibold"},"Bukti Fisik:",-1)),e("img",{src:`/storage/${a.invoice.invoice_image}`,alt:"Bukti Nota",class:"object-cover w-full h-32 rounded-md shadow cursor-pointer",onClick:t[2]||(t[2]=s=>G(a.invoice.invoice_image,a.invoice.invoice_number))},null,8,Ye)])):b("",!0)]),p.value==="edit"?(n(),i("div",Ze,[t[20]||(t[20]=e("h4",{class:"mb-3 font-bold text-yellow-800 dark:text-yellow-200"}," Tambah Item Baru / Pengganti ",-1)),f(ce,{isSearching:F.value,modelValue:y.value,"onUpdate:modelValue":t[3]||(t[3]=s=>y.value=s),results:w.value,onSelect:ee,placeholder:"Cari produk ..."},null,8,["isSearching","modelValue","results"])])):b("",!0),p.value==="edit"?(n(),i("div",et,[t[21]||(t[21]=e("h4",{class:"mb-3 font-bold dark:text-gray-200"}," Produk Belum Tertaut ",-1)),e("form",{onSubmit:V(W,["prevent"])},[p.value==="edit"&&a.unlinkedItems.length==0?(n(),i("p",tt," Semua produk sudah ditautkan. ")):(n(),i("div",st,[e("ul",at,[(n(!0),i($,null,H(a.unlinkedItems,s=>(n(),i("li",{key:s.id,class:"flex items-center justify-between w-full p-2 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700"},[e("label",{for:"link_item_"+s.id,class:"flex items-start w-full gap-2 text-sm cursor-pointer dark:text-gray-300"},[C(e("input",{id:"link_item_"+s.id,type:"checkbox",value:s.product_id,"onUpdate:modelValue":t[4]||(t[4]=r=>h.value=r),class:"rounded text-lime-600 mt-1.5"},null,8,lt),[[K,h.value]]),e("div",it,[e("div",nt,l(s.product.name)+" ("+l(s.product.code)+") ",1),e("div",rt,[e("span",dt," ("+l(s.quantity)+"x) @"+l(S(s.purchase_price)),1),e("span",ut," Subtotal: "+l(S(s.subtotal)),1)])])],8,ot)]))),128))])])),a.unlinkedItems.length>0?(n(),i("div",ct,[f(E,{type:"submit",disabled:h.value.length===0||u.value},{default:j(()=>[x(" Tautkan "+l(h.value.length)+" Item ",1)]),_:1},8,["disabled"])])):b("",!0)],32)])):b("",!0)])])]),_:1},8,["headerTitle"])],64))}};export{wt as default};
