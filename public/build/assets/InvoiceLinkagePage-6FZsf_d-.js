import{G as E,E as n,u as p,K as O,Q as U,H as $,p as J,_ as R,l as j,o as q,e as k,g as z,i as _,F as B,D as c}from"./vendor-core-PGoj2oEu.js";import{u as G}from"./useActionLoading-Ch10BqBo.js";import{d as K}from"./vendor-common-BBegFRNv.js";import V from"./MobileChecking-s8-R0Ay-.js";import"./useSidebar-DmXr-fe8.js";import"./vendor-charts-Bw6UNgWf.js";import"./app-X2KXb4KG.js";import"./BottomSheet-BwLNYbxn.js";/* empty css                                                                    */import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./UnlinkMobile-xBNVhb2p.js";import"./LinkedMobile-CKL5RAB5.js";import"./SearchMobile-Bc6z57z_.js";import"./HeaderMobile-CV0yYX5m.js";const ce={__name:"InvoiceLinkagePage",props:{purchase:Object,invoice:Object,unlinkedItems:Array,linkedItems:Array,products:{type:Array,default:()=>[]}},setup(u){const t=u,{isActionLoading:r}=G(),i=E(),s=n(!1),L=n(window.innerWidth<1024),f=()=>{L.value=window.innerWidth<1024},g=n([]),w=n([]),d=n([]),F=n(""),h=n([]),I=n(!1),m=p({ids:[],type:"link",newQty:0,newPrice:0}),v=p({product_id:[],type:"create",newQty:0,newPrice:0}),S=p({item_ids:[]}),y=p({items:[]});O(()=>{d.value=JSON.parse(JSON.stringify(t.linkedItems)),window.addEventListener("resize",f)}),U(()=>window.removeEventListener("resize",f)),$(()=>t.linkedItems,e=>{d.value=JSON.parse(JSON.stringify(e))},{deep:!0});const b=J(()=>d.value.reduce((e,a)=>{const o=(a.quantity||0)*(a.purchase_price||0);return e+o},0)),A=(e=null,a=0,o=0)=>{let l=[];if(e?(l=Array.isArray(e)?e:[e],m.newQty=a,m.newPrice=o):l=g.value,l.length===0){i.error("Pilih minimal satu item untuk ditautkan.");return}m.ids=l,r.value=!0,s.value=!0,m.post(route("purchases.linkItems",{purchase:t.purchase.id,invoice:t.invoice.id}),{preserveScroll:!0,onSuccess:()=>{i.success(`${l.length} item berhasil ditautkan.`),g.value=[],c.visit(window.location.href,{preserveScroll:!0,preserveState:!1})},onError:Q=>{i.error("Terjadi kesalahan pada server."),console.error(Q)},onFinish:()=>{s.value=!1,r.value=!1}})},N=(e=null)=>{let a=[];if(e?a=Array.isArray(e)?e:[e]:a=w.value,a.length===0){i.error("Pilih minimal satu item untuk dilepaskan.");return}S.item_ids=a,r.value=!0,s.value=!0,S.put(route("purchases.unlinkItems",{purchase:t.purchase.id,invoice:t.invoice.id}),{preserveScroll:!0,onSuccess:()=>{i.warning(`${a.length} item dilepaskan.`),w.value=[],c.visit(window.location.href,{preserveScroll:!0,preserveState:!1})},onFinish:()=>{s.value=!1,r.value=!1}})},P=e=>{if(linkedItems.value.some(o=>o.product_id===e.id)){i.warning("Produk ini sudah ada di daftar. Gunakan fitur edit untuk mengubah Qty.");return}v.product_id=[e.id],v.newQty=[e.qty],v.newPrice=[e.price],r.value=!0,s.value=!0,v.post(route("purchases.linkItems",{purchase:t.purchase.id,invoice:t.invoice.id}),{preserveScroll:!0,onSuccess:()=>{i.success("Produk tambahan berhasil dimasukkan."),c.visit(window.location.href,{preserveScroll:!0,preserveState:!1})},onFinish:()=>{s.value=!1,r.value=!1,F.value="",h.value=[]}})},C=()=>{if(d.value.some(e=>e.quantity<0)){i.error("Qty tidak boleh minus.");return}y.items=d.value,r.value=!0,s.value=!0,y.put(route("purchases.updateLinkedItemDetails",{purchase:t.purchase.id,invoice:t.invoice.id}),{preserveScroll:!0,onSuccess:()=>{i.success("Data berhasil diperbarui!"),c.reload({only:["linkedItems"]})},onFinish:()=>{s.value=!1,r.value=!1}})},D=()=>{if(t.invoice.status!=="validated"){if(b.value!==t.invoice.total_amount){i.error(`Total nominal (${b.value}) tidak sesuai dengan Target Nota (${t.invoice.total_amount}).`);return}confirm("Apakah Anda yakin data sudah benar? Aksi ini tidak bisa dibatalkan.")&&(r.value=!0,s.value=!0,c.put(route("purchases.validateInvoice",{purchase:t.purchase.id,invoice:t.invoice.id}),{},{preserveScroll:!0,onSuccess:()=>{i.success("Invoice Validated!"),c.visit(route("purchases.validate",t.purchase.id),{preserveScroll:!0,preserveState:!1})},onFinish:()=>{s.value=!1,r.value=!1}}))}},T=K.throttle(e=>{if(e.length<2){h.value=[];return}I.value=!0,h.value=t.products.filter(a=>a.name.toLowerCase().includes(e.toLowerCase())||a.code.toLowerCase().includes(e.toLowerCase())).slice(0,5),I.value=!1},300),M={validateInvoice:D,addNewSubstituteItem:P,handleSearchNewItem:T,saveCorrections:C,submitUnlinkage:N,submitLinkage:A,formatRupiah:e=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(e),formatTanggal:e=>e?new Date(e).toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"}):"-"};return(e,a)=>{const o=R("ImageModal");return q(),j(B,null,[k(o,{show:e.showImageModal,imageUrl:e.selectedImageUrl,productName:e.selectedInvoiceCode,onClose:a[0]||(a[0]=l=>e.showImageModal=!1)},null,8,["show","imageUrl","productName"]),k(z(_),{title:`Invoice #${u.invoice.invoice_number}`},null,8,["title"]),k(V,{invoice:u.invoice,unlinkedItems:u.unlinkedItems,linkedItems:u.linkedItems,products:u.products,actions:M},null,8,["invoice","unlinkedItems","linkedItems","products"])],64)}}};export{ce as default};
