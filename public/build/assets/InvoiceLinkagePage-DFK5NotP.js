import{G as Q,E as l,u as I,L as R,N as J,H as j,p as q,_ as z,l as w,o as y,e as f,g as C,i as B,F as G,D as d}from"./vendor-core-n0E2YlDl.js";import{u as K}from"./useActionLoading-De_ETMek.js";import{d as V}from"./vendor-common-BBegFRNv.js";import W from"./MobileChecking-DTz-U5nh.js";import x from"./DesktopChecking-CUByXLJt.js";import"./vendor-charts-Bw6UNgWf.js";import"./BottomSheet-CW6tJypf.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./BarcodeScanner-CrxlsICI.js";import"./vendor-scanner-WiLeg4yL.js";import"./UnlinkMobile-4pw08aYh.js";import"./LinkedMobile-CXtOjWqA.js";import"./SearchMobile-zNrfVa9b.js";import"./HeaderMobile-C4qea-Sk.js";import"./AuthenticatedLayout-BaGcqBdf.js";import"./useSidebar-B9fx8wpQ.js";import"./PrimaryButton-CtmJntPf.js";const H={key:0},X={key:1},ke={__name:"InvoiceLinkagePage",props:{purchase:Object,invoice:Object,unlinkedItems:Array,linkedItems:Array,products:{type:Array,default:()=>[]}},setup(a){const i=a,{isActionLoading:r}=K(),n=Q(),o=l(!1),S=l(window.innerWidth<1024),b=()=>{S.value=window.innerWidth<1024},m=l([]),v=l([]),c=l([]),L=l(""),p=l([]),g=l(!1),h=I({ids:[],type:"link",newQty:0,newPrice:0}),k=I({product_id:[],type:"create",newQty:0,newPrice:0}),F=I({item_ids:[]}),N=I({items:[]});R(()=>{c.value=JSON.parse(JSON.stringify(i.linkedItems)),window.addEventListener("resize",b)}),J(()=>window.removeEventListener("resize",b)),j(()=>i.linkedItems,e=>{c.value=JSON.parse(JSON.stringify(e))},{deep:!0});const A=q(()=>c.value.reduce((e,t)=>{const u=(t.quantity||0)*(t.purchase_price||0);return e+u},0)),D=(e=null,t=0,u=0)=>{let s=[];if(e?(s=Array.isArray(e)?e:[e],h.newQty=t,h.newPrice=u):s=m.value,s.length===0){n.error("Pilih minimal satu item untuk ditautkan.");return}h.ids=s,r.value=!0,o.value=!0,h.post(route("purchases.linkItems",{purchase:i.purchase.id,invoice:i.invoice.id}),{preserveScroll:!0,onSuccess:()=>{n.success(`${s.length} item berhasil ditautkan.`),m.value=[],d.visit(window.location.href,{preserveScroll:!0,preserveState:!1})},onError:O=>{n.error("Terjadi kesalahan pada server."),console.error(O)},onFinish:()=>{o.value=!1,r.value=!1}})},T=(e=null)=>{let t=[];if(e?t=Array.isArray(e)?e:[e]:t=v.value,t.length===0){n.error("Pilih minimal satu item untuk dilepaskan.");return}F.item_ids=t,r.value=!0,o.value=!0,F.put(route("purchases.unlinkItems",{purchase:i.purchase.id,invoice:i.invoice.id}),{preserveScroll:!0,onSuccess:()=>{n.warning(`${t.length} item dilepaskan.`),v.value=[],d.visit(window.location.href,{preserveScroll:!0,preserveState:!1})},onFinish:()=>{o.value=!1,r.value=!1}})},M=e=>{if(linkedItems.value.some(u=>u.product_id===e.id)){n.warning("Produk ini sudah ada di daftar. Gunakan fitur edit untuk mengubah Qty.");return}k.product_id=[e.id],k.newQty=[e.qty],k.newPrice=[e.price],r.value=!0,o.value=!0,k.post(route("purchases.linkItems",{purchase:i.purchase.id,invoice:i.invoice.id}),{preserveScroll:!0,onSuccess:()=>{n.success("Produk tambahan berhasil dimasukkan."),d.visit(window.location.href,{preserveScroll:!0,preserveState:!1})},onFinish:()=>{o.value=!1,r.value=!1,L.value="",p.value=[]}})},$=()=>{if(c.value.some(e=>e.quantity<0)){n.error("Qty tidak boleh minus.");return}N.items=c.value,r.value=!0,o.value=!0,N.put(route("purchases.updateLinkedItemDetails",{purchase:i.purchase.id,invoice:i.invoice.id}),{preserveScroll:!0,onSuccess:()=>{n.success("Data berhasil diperbarui!"),d.reload({only:["linkedItems"]})},onFinish:()=>{o.value=!1,r.value=!1}})},E=()=>{if(i.invoice.status!=="validated"){if(A.value!==i.invoice.total_amount){n.error(`Total nominal (${A.value}) tidak sesuai dengan Target Nota (${i.invoice.total_amount}).`);return}confirm("Apakah Anda yakin data sudah benar? Aksi ini tidak bisa dibatalkan.")&&(r.value=!0,o.value=!0,d.put(route("purchases.validateInvoice",{purchase:i.purchase.id,invoice:i.invoice.id}),{},{preserveScroll:!0,onSuccess:()=>{n.success("Invoice Validated!"),d.visit(route("purchases.validate",i.purchase.id),{preserveScroll:!0,preserveState:!1})},onFinish:()=>{o.value=!1,r.value=!1}}))}},P=V.throttle(e=>{if(e.length<2){p.value=[];return}g.value=!0,p.value=i.products.filter(t=>t.name.toLowerCase().includes(e.toLowerCase())||t.code.toLowerCase().includes(e.toLowerCase())).slice(0,5),g.value=!1},300),U={validateInvoice:E,addNewSubstituteItem:M,handleSearchNewItem:P,saveCorrections:$,submitUnlinkage:T,submitLinkage:D,formatRupiah:e=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(e),formatTanggal:e=>e?new Date(e).toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"}):"-"};return(e,t)=>{const u=z("ImageModal");return y(),w(G,null,[f(u,{show:e.showImageModal,imageUrl:e.selectedImageUrl,productName:e.selectedInvoiceCode,onClose:t[0]||(t[0]=s=>e.showImageModal=!1)},null,8,["show","imageUrl","productName"]),f(C(B),{title:`Invoice #${a.invoice.invoice_number}`},null,8,["title"]),S.value?(y(),w("div",H,[f(W,{purchase:a.purchase,invoice:a.invoice,unlinkedItems:a.unlinkedItems,linkedItems:a.linkedItems,products:a.products,actions:U},null,8,["purchase","invoice","unlinkedItems","linkedItems","products"])])):(y(),w("div",X,[f(x,{purchase:a.purchase,invoice:a.invoice,unlinkedItems:a.unlinkedItems,editableLinkedItems:c.value,products:a.products,actions:U,selectedLinkItemIds:m.value,"onUpdate:selectedLinkItemIds":t[1]||(t[1]=s=>m.value=s),selectedUnlinkItemIds:v.value,"onUpdate:selectedUnlinkItemIds":t[2]||(t[2]=s=>v.value=s),searchResults:p.value,"is-searching":g.value,"onUpdate:searchKeyword":t[3]||(t[3]=s=>{L.value=s,C(P)(s)})},null,8,["purchase","invoice","unlinkedItems","editableLinkedItems","products","selectedLinkItemIds","selectedUnlinkItemIds","searchResults","is-searching"])]))],64)}}};export{ke as default};
