import{q as pe,v as i,D as C,u as ye,K as ae,x as ve,a as me,S as ge,l as ee,o as Q,e as q,d as he,p as te,f as c,g as l,i as be,t as ce,k as ke,F as _e}from"./vendor-core-By7Plnkm.js";import{j as we}from"./vendor-common-GpUWqhKr.js";import xe from"./ConfirmSubmit-BcW5qmYe.js";import Se from"./Cart-DjZlvKin.js";import{_ as Ce}from"./BarcodeScanner-DKRXhBOH.js";import qe from"./FilterProduct-BQl2g2i2.js";import Fe from"./ProductDetailModal-BqI2Y1FV.js";import Te from"./ProductComparisonModal-Br3KQz45.js";import Me from"./TransactionSuccessModal-C9copKkE.js";import Ae from"./ProductList-DjiML4g8.js";import Pe from"./PosQtyModal-BteMMdXL.js";import"./vendor-charts-Bw6UNgWf.js";import"./BottomSheet-CbDDnn2t.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./InputRupiah-BO9l6Y_n.js";import"./MoneyInput-BgfUFfy0.js";import"./vendor-scanner-og__AIM6.js";function Ee(k){const m=pe(),f="POS_REALTIME_DRAFT_V3",p=i([]),h=i(!1),y=i(20),u=i(!0),v=i({search:"",category:"all",subCategory:"all",brand:"all",sort:"default",hideEmptyStock:!0}),_=i([]),F=i(""),b=i([]),w=i(null),M=i([]),z=C(()=>k.mode==="edit"),g=k.sale||null,n=ye({id:g?.id||null,input_type:g?.input_type||"realtime",report_date:g?.transaction_date||(()=>{const e=new Date,a=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${a}-${r}-${s}`})(),items:g?.items?.map(e=>{const a=e.product,r=e.product_snapshot||{},s=a?.name||r.name||"Unknown Item",t=a?.code||r.code||"-";let o=a?.category;return!o&&r.category&&(o={name:r.category}),{product_id:e.product_id,code:t,name:s,category:o,unit:a?.unit||(r.unit?{name:r.unit}:null),size:a?.size,stock_max:parseFloat(a?.stock||0)+parseFloat(e.quantity),selling_price:parseFloat(e.selling_price),original_price:parseFloat(e.selling_price),quantity:parseFloat(e.quantity),original_quantity:parseFloat(e.quantity),subtotal:parseFloat(e.subtotal)}})||[],customer_id:g?.customer_id||null,payment_amount:g?parseFloat(g.total_payment):0,change_amount:g?parseFloat(g.change_amount):0,payment_method:g?.payment_method||"cash",discount_type:g?.discount_type||"fixed",discount_value:g?.discount_value||0,notes:g?.notes||""}),T=C(()=>n.items.reduce((e,a)=>e+(parseFloat(a.subtotal)||0),0)),J=C(()=>{const e=parseFloat(n.discount_value)||0;if(e<=0)return 0;if(n.discount_type==="percent"){const a=e>100?100:e;return Math.round(T.value*a/100)}return e>T.value?T.value:e}),A=C(()=>{const e=T.value-J.value,a=e>0?e:0;return a===0&&n.payment_amount>0,a}),H=C(()=>(parseFloat(n.payment_amount)||0)-A.value),se=C(()=>n.payment_method!=="cash"&&n.payment_method!==""?!0:(parseFloat(n.payment_amount)||0)>=A.value),oe=C(()=>n.items.some(e=>e.quantity<=0||isNaN(e.quantity))),K=C(()=>{const e=A.value;if(e<=0)return[];const a=[{label:"Uang Pas",value:e}];if([2e3,5e3,1e4,2e4,5e4,1e5].forEach(s=>{s>e&&!a.find(t=>t.value===s)&&a.push({label:U(s),value:s})}),e>5e4){const s=Math.ceil(e/5e4)*5e4;a.find(t=>t.value===s)||a.push({label:U(s),value:s})}return a.slice(0,4)}),P=e=>{e.unit?.is_decimal===1||(e.quantity=Math.round(e.quantity),e.quantity<1&&(e.quantity=1)),e.quantity>e.stock_max&&(e.quantity=e.stock_max,m.warning(`Stok sisa ${e.stock_max}`)),e.subtotal=Math.round(e.quantity*e.selling_price)},de=e=>{const a=parseFloat(e.subtotal)||0,r=parseFloat(e.selling_price)||0;if(!(r<=0))if(e.unit?.is_decimal===1){let s=a/r;s>e.stock_max&&(s=e.stock_max,e.subtotal=Math.round(s*r),m.warning("Melebihi sisa stok!")),e.quantity=parseFloat(s.toFixed(4))}else confirm(`âš ï¸ Ubah harga satuan agar sesuai total ${U(a)}?`)?e.quantity>0&&(e.selling_price=Math.round(a/e.quantity)):e.subtotal=Math.round(e.quantity*e.selling_price)},N=e=>{e.subtotal=Math.round(e.quantity*e.selling_price)},ne=e=>{const a=["Jasa","Layanan"].includes(e.category?.name);if(!a&&parseFloat(e.stock)<=0){m.error("Stok habis!");return}const r=n.items.find(s=>s.product_id===e.id);if(r){if(a){m.warning(`Jasa "${e.name}" sudah ada di keranjang.`);return}if(r.quantity+1>e.stock){m.warning("Stok maksimal!");return}r.quantity++,P(r)}else{const s=parseFloat(e.selling_price||e.price);n.items.push({product_id:e.id,code:e.code,name:e.name,image_url:e.image_url,category:e.category,unit:e.unit,size:e.size,stock_max:parseFloat(e.stock),selling_price:s,original_price:s,quantity:1,original_quantity:0,subtotal:s,is_service:a})}},E=e=>n.items.splice(e,1),D=(e,a)=>{const r=n.items[e],s=parseFloat(r.quantity)+a;if(s>r.stock_max){m.warning(`Stok sisa ${r.stock_max}`);return}if(s<=0){confirm("Hapus item ini?")&&E(e);return}r.quantity=s,P(r)},B=e=>{n.payment_amount=e.value},j=()=>{n.payment_amount=0},I=()=>{p.value.length&&n.items.forEach(e=>{const a=p.value.find(r=>r.id===e.product_id);if(a){const r=e.original_quantity||0,s=parseFloat(a.stock);e.stock_max=s+r,e.quantity>e.stock_max&&(m.warning(`Stok ${e.name} berubah! Disesuaikan ke max: ${e.stock_max}`),e.quantity=e.stock_max,P(e))}})},S=i(new Map),L=i([]),$=i([]),x=async(e={})=>{const a=y.value,r=e.search||v.value.search,s={query:r,limit:a,category_id:r?"all":v.value.category,product_type_id:r?"all":v.value.subCategory,brand_id:r?"all":v.value.brand,sort:v.value.sort,hide_empty_stock:v.value.hideEmptyStock?1:0,size_id:r?"all":v.value.size||"all"},t=JSON.stringify(s);if(S.value.has(t)){const o=S.value.get(t);Array.isArray(o)?p.value=o:(p.value=o.products,L.value=o.available_brands||[],$.value=o.available_sizes||[],o.products.length<a?u.value=!1:u.value=!0),I()}else h.value=!0;try{const d=(await me.get(route("sales.products.lite"),{params:s})).data;let G=[];Array.isArray(d)?G=d:(G=d.products,L.value=d.available_brands||[],$.value=d.available_sizes||[]),p.value=G,G.length<a?u.value=!1:u.value=!0,S.value.set(t,d),I()}catch(o){console.error("Gagal load produk:",o),S.value.has(t)||m.error("Gagal memuat database produk")}finally{h.value=!1}},W=we(()=>{y.value=20,u.value=!0,x()},400);ae(()=>v.value,(e,a)=>{e.search!==a.search?(h.value=!0,W()):((e.category!==a.category||e.subCategory!==a.subCategory||e.brand!==a.brand)&&(y.value=20,u.value=!0,p.value=[]),x())},{deep:!0});const Y=C(()=>p.value),R=()=>{!u.value||h.value||(y.value+=12,x())},O=async()=>{try{const e=await me.get(route("sales.products.lite"),{params:{only_services:!0,limit:100}});e.data.products?M.value=e.data.products:Array.isArray(e.data)?M.value=e.data:M.value=[]}catch(e){console.error("Gagal load layanan:",e)}},re=e=>{w.value=e,n.customer_id=e.id,b.value=[],F.value=""};ae(F,e=>{if(!e||!k.customers){b.value=[];return}const a=e.toLowerCase(),r=k.customers.filter(s=>s.name.toLowerCase().includes(a)||s.code.toLowerCase().includes(a));b.value=r.slice(0,5)});const le=e=>{const a=k.customers.find(r=>r.member_code==e||r.phone==e);a?re(a):m.warning("Member tidak ditemukan")},X=()=>{if(z.value)return;const e=localStorage.getItem(f);if(e)try{const a=JSON.parse(e);a.items&&(n.items=a.items),n.payment_amount=a.payment_amount||0,n.payment_method=a.payment_method||"cash",n.notes=a.notes||"",n.discount_type=a.discount_type||"fixed",n.discount_value=a.discount_value||0,a.selectedMember&&(w.value=a.selectedMember,n.customer_id=a.selectedMember.id)}catch{localStorage.removeItem(f)}};ae([()=>n.items,()=>n.customer_id,()=>n.payment_amount,()=>n.discount_value,()=>n.notes],()=>{localStorage.setItem(f,JSON.stringify({items:n.items,customer_id:n.customer_id,payment_amount:n.payment_amount,payment_method:n.payment_method,notes:n.notes,discount_type:n.discount_type,discount_value:n.discount_value,selectedMember:w.value}))},{deep:!0});const ie=(e=!1)=>new Promise((a,r)=>{const s=H.value,t=A.value;n.change_amount=s,n.payment_amount=parseFloat(n.payment_amount);const o={onSuccess:d=>{const fe=(d.props.flash||{}).sale_id;z.value||(x(),localStorage.removeItem(f),n.reset(),n.items=[],w.value=null),a({success:!0,saleId:fe,change:s,total:t})},onError:d=>{console.error(d),m.error("Gagal memproses transaksi"),r(d)},onFinish:()=>{}};z.value?n.transform(d=>({...d})).put(route("sales.update",n.id),o):n.transform(d=>({...d,print_invoice:e})).post(route("sales.pos.store"),o)}),U=e=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(e),ue=e=>{const a=_.value.findIndex(r=>r.id===e.id);if(a!==-1)_.value.splice(a,1);else{if(_.value.length>=5){m.warning("Maksimal 5 produk untuk perbandingan.");return}_.value.push(e)}},V=()=>{_.value=[]},Z=e=>_.value.some(a=>a.id===e);return ve(()=>{if(x(),O(),X(),z.value){const e=new Date().toISOString().slice(0,10);n.report_date=e}}),{form:n,filterState:v,allProducts:p,filteredProducts:Y,isFetchingData:h,compareList:_,serviceProducts:M,dynamicBrands:L,dynamicSizes:$,memberSearch:F,memberSearchResults:b,selectedMember:w,subTotal:T,discountAmount:J,grandTotal:A,changeAmount:H,isPaymentSufficient:se,hasInvalidQty:oe,moneySuggestions:K,loadMoreProducts:R,queryMember:le,addItem:ne,removeItem:E,updateQty:D,resetPayment:j,handleMoneyClick:B,recalcFromQty:P,recalcFromSubtotal:de,recalcFromPrice:N,toggleCompare:ue,clearCompare:V,isInCompare:Z,submitTransaction:ie,rp:U}}function De(k=3e4){const m=i(!1);let f=null,p=null;const h=async()=>{try{"wakeLock"in navigator&&(f=await navigator.wakeLock.request("screen"),f.addEventListener("release",()=>{}))}catch(b){console.error(`${b.name}, ${b.message}`)}},y=async()=>{f!==null&&(await f.release(),f=null)},u=async()=>{f!==null&&document.visibilityState==="visible"&&await h()},v=()=>{m.value=!1,p&&clearTimeout(p),p=setTimeout(()=>{m.value=!0},k)},_=()=>{["mousemove","keydown","touchstart","click","scroll"].forEach(w=>{window.addEventListener(w,v)})},F=()=>{["mousemove","keydown","touchstart","click","scroll"].forEach(w=>{window.removeEventListener(w,v)})};return ve(()=>{h(),document.addEventListener("visibilitychange",u),_(),v()}),ge(()=>{y(),document.removeEventListener("visibilitychange",u),F(),p&&clearTimeout(p)}),{isDimmed:m,requestWakeLock:h,releaseWakeLock:y,resetIdleTimer:v}}const Ie={class:"flex flex-col lg:flex-row h-[100dvh] w-full bg-gray-100 dark:bg-gray-900 overflow-hidden font-sans transition-colors duration-300"},Le={class:"relative flex flex-col flex-1 h-full overflow-hidden"},$e={key:0,class:"absolute z-40 bottom-24 lg:bottom-8 right-4 flex items-center bg-gray-900 dark:bg-gray-800 text-white pl-4 pr-1 py-1.5 gap-4 rounded-full shadow-xl animate-bounce-subtle border border-gray-700"},ze={class:"text-xs font-bold whitespace-nowrap"},Ne={class:"flex items-center gap-1"},Be={key:1,class:"absolute z-30 lg:hidden bottom-4 left-4 right-4"},Re={class:"flex items-center gap-3"},Ue={class:"flex items-center justify-center text-xs font-bold text-white rounded-full shadow-sm bg-lime-500 dark:bg-white dark:text-lime-700 w-7 h-7"},je={class:"flex flex-col items-start leading-none gap-0.5"},Oe={class:"text-lg font-bold"},lt={__name:"index",props:{categories:Array,customers:Array,brands:Array,sale:Object,mode:String},setup(k){const f=Ee(k),{isDimmed:p,resetIdleTimer:h}=De(),{form:y,filterState:u,allProducts:v,filteredProducts:_,isFetchingData:F,dynamicBrands:b,dynamicSizes:w,grandTotal:M,changeAmount:z,isPaymentSufficient:g,hasInvalidQty:n,addItem:T,loadMoreProducts:J,queryProduk:A,queryMember:H,submitTransaction:se,rp:oe,toggleCompare:K,clearCompare:P,isInCompare:de,compareList:N}=f,ne=pe(),E=i(!1),D=i(!1),B=i(!1),j=i(!1),I=i(!1),S=i(!1),L=i(!1),$=i(!1),x=i("product"),W=i(null);i(null),ae(u,async()=>{},{deep:!0});const Y=()=>{j.value=!1,y.reset(),y.items=[]},R=i({id:null,name:"",code:"",price:0,quantity:1,stock:0,unit:"Pcs",image:null}),O=s=>{R.value={id:s.id,name:s.name,code:s.code,image_url:s.image_url,price:parseFloat(s.selling_price||s.price||0),quantity:1,stock:parseInt(s.stock||0),unit:s.unit?.name||"Pcs"},S.value=!0},re=s=>{const t={id:s.id,name:s.name,code:s.code,image_url:s.image_url,price:parseFloat(s.selling_price||s.price||0),quantity:1,stock:parseInt(s.stock||0),unit:s.unit?.name||"Pcs"};T(t)},le=s=>{W.value=s,L.value=!0},X=()=>{x.value="product",D.value=!0},ie=()=>{x.value="member",D.value=!0},U=async s=>{if(D.value=!1,alert("scan berhasil "+x.value+" | "+s),x.value=="product")try{const t=await A(s);t?(s=t,O(s)):alert("Produk tidak ditemukan di database.")}catch(t){console.error("Terjadi kesalahan saat query produk:",t),alert("Gagal mengambil data produk.")}else x.value=="member"&&(s=H(s))},ue=(s=!1)=>{T(R.value),S.value=!1,s&&X()},V=i(0),Z=i(0),e=i(null),a=s=>{I.value=!0,se(s).then(t=>{I.value=!1,B.value=!1,t.success?(V.value=t.change,Z.value=t.total,j.value=!0,e.value?.resetStep(),E.value=!1):ne.success("Transaksi berhasil disimpan.")}).catch(t=>{console.error("Error submitting transaction:",t),I.value=!1})},r=()=>{document.activeElement&&["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&document.activeElement.blur()};return(s,t)=>(Q(),ee(_e,null,[q(l(be),{title:"Kasir POS"}),q(Fe,{show:L.value,product:W.value,onClose:t[0]||(t[0]=o=>L.value=!1),onAddToCart:t[1]||(t[1]=o=>{O(o)})},null,8,["show","product"]),q(Te,{show:$.value,products:l(N),onClose:t[2]||(t[2]=o=>$.value=!1),onRemove:l(K),onAddToCart:t[3]||(t[3]=o=>{O(o)})},null,8,["show","products","onRemove"]),D.value?(Q(),he(Ce,{key:0,onResult:U,onClose:t[4]||(t[4]=o=>D.value=!1)})):te("",!0),c("div",Ie,[l(p)?(Q(),ee("div",{key:0,onClick:t[5]||(t[5]=(...o)=>l(h)&&l(h)(...o)),class:"fixed inset-0 z-[9999] bg-black/90 flex flex-col items-center justify-center cursor-pointer transition-opacity duration-1000"},[...t[21]||(t[21]=[c("div",{class:"text-center animate-pulse"},[c("span",{class:"text-6xl mb-4 block"},"ðŸŒ™"),c("p",{class:"text-white/50 text-sm font-light tracking-widest uppercase"},"Mode Hemat Daya"),c("p",{class:"text-white/30 text-xs mt-2"},"Sentuh layar untuk kembali")],-1)])])):te("",!0),c("div",Le,[q(qe,{categories:k.categories,brands:l(b)?.length?l(b):k.brands,sizes:l(w),"is-fetching":l(F),search:l(u).search,"onUpdate:search":t[6]||(t[6]=o=>l(u).search=o),category:l(u).category,"onUpdate:category":t[7]||(t[7]=o=>l(u).category=o),subCategory:l(u).subCategory,"onUpdate:subCategory":t[8]||(t[8]=o=>l(u).subCategory=o),brand:l(u).brand,"onUpdate:brand":t[9]||(t[9]=o=>l(u).brand=o),size:l(u).size,"onUpdate:size":t[10]||(t[10]=o=>l(u).size=o),sort:l(u).sort,"onUpdate:sort":t[11]||(t[11]=o=>l(u).sort=o),hideEmptyStock:l(u).hideEmptyStock,"onUpdate:hideEmptyStock":t[12]||(t[12]=o=>l(u).hideEmptyStock=o),onScan:X},null,8,["categories","brands","sizes","is-fetching","search","category","subCategory","brand","size","sort","hideEmptyStock"]),q(Ae,{products:l(_),"is-fetching":l(F),"cart-items":l(y).items,"all-products-count":l(v).length,"compare-list":l(N),onLoadMore:l(J),onAddToCart:re,onOpenDetail:le,onToggleCompare:l(K),onScrollList:r},null,8,["products","is-fetching","cart-items","all-products-count","compare-list","onLoadMore","onToggleCompare"]),l(N)?.length>0?(Q(),ee("div",$e,[c("div",ze,ce(l(N).length)+" Banding ",1),c("div",Ne,[c("button",{onClick:t[13]||(t[13]=o=>$.value=!0),class:"px-3 py-1.5 bg-lime-500 hover:bg-lime-400 text-black text-xs font-bold rounded-full transition"}," Buka "),c("button",{onClick:t[14]||(t[14]=(...o)=>l(P)&&l(P)(...o)),class:"p-1.5 hover:bg-gray-700 rounded-full text-gray-400 hover:text-white transition"},[...t[22]||(t[22]=[c("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[c("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])])])):te("",!0),l(y).items.length>0?(Q(),ee("div",Be,[c("button",{onClick:t[15]||(t[15]=o=>E.value=!0),class:"w-full bg-gray-900 dark:bg-lime-600 text-white p-3.5 rounded-2xl shadow-xl shadow-gray-900/20 flex justify-between items-center animate-bounce-subtle"},[c("div",Re,[c("span",Ue,ce(l(y).items.reduce((o,d)=>o+parseFloat(d.quantity),0)),1),c("div",je,[t[23]||(t[23]=c("span",{class:"text-[9px] text-gray-400 dark:text-lime-100 uppercase font-bold tracking-wider"},"Total Belanja",-1)),c("span",Oe,ce(l(oe)(l(M))),1)])]),t[24]||(t[24]=c("span",{class:"flex items-center gap-1 px-4 py-2 text-xs font-bold bg-gray-700 dark:bg-lime-800/30 rounded-xl"},[ke(" Bayar "),c("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[c("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M14 5l7 7m0 0l-7 7m7-7H3"})])],-1))])])):te("",!0)]),q(Se,{ref_key:"cartRef",ref:e,showMobileCart:E.value,reprops:l(f),onOpenScanMember:ie,onShowBayar:t[16]||(t[16]=o=>B.value=!0),onShowDesktop:t[17]||(t[17]=o=>E.value=!1)},null,8,["showMobileCart","reprops"])]),q(Pe,{show:S.value,item:R.value,"onUpdate:item":t[18]||(t[18]=o=>R.value=o),onClose:t[19]||(t[19]=o=>S.value=!1),onAddToCart:ue},null,8,["show","item"]),q(xe,{showConfirmModal:B.value,changeAmount:l(z),grandTotal:l(M),paymentAmount:parseFloat(l(y).payment_amount),processing:I.value,onClose:t[20]||(t[20]=o=>B.value=!1),onConfirmTransaction:a},null,8,["showConfirmModal","changeAmount","grandTotal","paymentAmount","processing"]),q(Me,{show:j.value,changeAmount:V.value,total:Z.value,onClose:Y,onNewTransaction:Y},null,8,["show","changeAmount","total"])],64))}};export{lt as default};
