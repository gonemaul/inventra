import{q as V,v as o,u as g,x as z,S as K,K as _,D as B,l as b,o as P,e as v,g as x,i as H,F as W,J as m}from"./vendor-core-By7Plnkm.js";import{u as G}from"./useActionLoading-BREuot5v.js";import{d as X}from"./vendor-common-GpUWqhKr.js";import{_ as Y}from"./ImageModal-CcXc5Msr.js";import Z from"./MobileChecking-CCIYaIIy.js";import ee from"./DesktopChecking-Bhca6kD1.js";import{a as te}from"./AuthenticatedLayout-BlgKae2S.js";import"./vendor-charts-Bw6UNgWf.js";import"./BottomSheet-CbDDnn2t.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./BarcodeScanner-DKRXhBOH.js";import"./vendor-scanner-og__AIM6.js";import"./UnlinkMobile-DOehTzsv.js";import"./LinkedMobile-Cejwlc8e.js";import"./SearchMobile-C2q4DMDb.js";import"./HeaderMobile-CirjYz37.js";import"./InputRupiah-BO9l6Y_n.js";import"./PrimaryButton-BZrDt8zt.js";import"./useSidebar-CpEDRVzi.js";const ie={key:0},ae={key:1},Le={__name:"InvoiceLinkagePage",props:{purchase:Object,invoice:Object,unlinkedItems:Array,linkedItems:Array,products:{type:Array,default:()=>[]}},setup(s){const a=s,{isActionLoading:l}=G(),r=V(),u=o(!1),w=o(!1),L=o(null),F=o(null),Q=(e,t)=>{L.value=e,F.value="Invoice-#"+t,w.value=!0},A=o(window.innerWidth<1024),N=()=>{A.value=window.innerWidth<1024},h=o([]),p=o([]),c=o([]),U=o(""),k=o([]),y=o(!1),f=g({ids:[],type:"link",newQty:0,newPrice:0}),I=g({product_id:null,type:"create",newQty:0,newPrice:0}),E=g({item_ids:[]}),S=g({items:[]});z(()=>{c.value=JSON.parse(JSON.stringify(a.linkedItems)),window.addEventListener("resize",N)}),K(()=>window.removeEventListener("resize",N)),_(()=>a.linkedItems,e=>{c.value=JSON.parse(JSON.stringify(e))},{deep:!0});const T=B(()=>c.value.reduce((e,t)=>{const i=(t.quantity||0)*(t.purchase_price||0);return e+i},0)),j=(e=null,t=0,i=0)=>{let n=[];if(e?(n=Array.isArray(e)?e:[e],f.newQty=t,f.newPrice=i):n=h.value,n.length===0){r.error("Pilih minimal satu item untuk ditautkan.");return}return f.ids=n,l.value=!0,u.value=!0,new Promise((d,M)=>{f.post(route("purchases.linkItems",{purchase:a.purchase.id,invoice:a.invoice.id}),{preserveScroll:!0,onSuccess:()=>{r.success(`${n.length} item berhasil ditautkan.`),h.value=[],m.visit(window.location.href,{preserveScroll:!0,preserveState:!1}),d(!0)},onError:C=>{r.error("Terjadi kesalahan pada server."),console.error(C),M(C)},onFinish:()=>{u.value=!1,l.value=!1}})})},q=(e=null)=>{let t=[];if(e?t=Array.isArray(e)?e:[e]:t=p.value,t.length===0){r.error("Pilih minimal satu item untuk dilepaskan.");return}return E.item_ids=t,l.value=!0,u.value=!0,new Promise((i,n)=>{E.put(route("purchases.unlinkItems",{purchase:a.purchase.id,invoice:a.invoice.id}),{preserveScroll:!0,onSuccess:()=>{r.warning(`${t.length} item dilepaskan.`),p.value=[],m.visit(window.location.href,{preserveScroll:!0,preserveState:!1}),i(!0)},onError:d=>{n(d)},onFinish:()=>{u.value=!1,l.value=!1}})})},O=e=>{if(e&&e.id)I.product_id=e.id,I.newQty=e.newQty,I.newPrice=e.newPrice;else{r.error("Pilih produk yang valid untuk ditambahkan.");return}if(a.linkedItems.some(i=>i.product_id===e.id)){r.warning("Produk ini sudah ada di daftar. Gunakan fitur edit untuk mengubah Qty.");return}return l.value=!0,u.value=!0,new Promise((i,n)=>{I.post(route("purchases.linkItems",{purchase:a.purchase.id,invoice:a.invoice.id}),{preserveScroll:!0,onSuccess:()=>{r.success("Produk tambahan berhasil dimasukkan."),m.visit(window.location.href,{preserveScroll:!0,preserveState:!1}),i(!0)},onError:d=>{r.error(`Terdapat kesalahan : ${d}`),console.log(d),n(d)},onFinish:()=>{u.value=!1,l.value=!1,U.value="",k.value=[]}})})},R=(e=null)=>{if(e){if(e.quantity<0)return r.error("Qty tidak boleh minus."),Promise.reject("Validation Error");if(e.purchase_price<0)return r.error("Harga tidak boleh minus."),Promise.reject("Validation Error");const t=c.value.findIndex(i=>i.id===e.id);t!==-1&&(c.value[t].quantity=e.quantity,c.value[t].purchase_price=e.purchase_price),S.items=[e]}else{if(c.value.some(i=>i.quantity<0||i.purchase_price<0))return r.error("Terdapat data Qty atau Harga yang minus. Cek kembali."),Promise.reject("Validation Error");S.items=c.value}return l.value=!0,u.value=!0,new Promise((t,i)=>{S.put(route("purchases.updateLinkedItemDetails",{purchase:a.purchase.id,invoice:a.invoice.id}),{preserveScroll:!0,onSuccess:()=>{const n=e?"Item berhasil diperbarui!":"Semua data berhasil disimpan!";r.success(n),m.reload({only:["linkedItems"]}),t(!0)},onError:n=>{n.items&&r.error(n.items),i(n)},onFinish:()=>{u.value=!1,l.value=!1}})})},J=()=>{if(a.invoice.status!=="validated"){if(T.value!==a.invoice.total_amount){r.error(`Total nominal (${T.value}) tidak sesuai dengan Target Nota (${a.invoice.total_amount}).`);return}confirm("Apakah Anda yakin data sudah benar? Aksi ini tidak bisa dibatalkan.")&&(l.value=!0,u.value=!0,m.put(route("purchases.validateInvoice",{purchase:a.purchase.id,invoice:a.invoice.id}),{},{preserveScroll:!0,onSuccess:()=>{r.success("Invoice Validated!"),m.visit(route("purchases.validate",a.purchase.id),{preserveScroll:!0,preserveState:!1})},onFinish:()=>{u.value=!1,l.value=!1}}))}},D=X.throttle(e=>{if(e.length<2){k.value=[];return}y.value=!0,k.value=a.products.filter(t=>t.name.toLowerCase().includes(e.toLowerCase())||t.code.toLowerCase().includes(e.toLowerCase())).slice(0,5),y.value=!1},300),$={validateInvoice:J,addNewSubstituteItem:O,handleSearchNewItem:D,saveCorrections:R,submitUnlinkage:q,submitLinkage:j,formatRupiah:e=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(e),formatTanggal:e=>e?new Date(e).toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"}):"-",openImageModal:Q};return(e,t)=>(P(),b(W,null,[v(te),v(Y,{show:w.value,imageUrl:L.value,productName:F.value,onClose:t[0]||(t[0]=i=>w.value=!1)},null,8,["show","imageUrl","productName"]),v(x(H),{title:`Invoice #${s.invoice.invoice_number}`},null,8,["title"]),A.value?(P(),b("div",ie,[v(Z,{purchase:s.purchase,invoice:s.invoice,unlinkedItems:s.unlinkedItems,linkedItems:s.linkedItems,products:s.products,actions:$},null,8,["purchase","invoice","unlinkedItems","linkedItems","products"])])):(P(),b("div",ae,[v(ee,{purchase:s.purchase,invoice:s.invoice,unlinkedItems:s.unlinkedItems,editableLinkedItems:c.value,products:s.products,actions:$,selectedLinkItemIds:h.value,"onUpdate:selectedLinkItemIds":t[1]||(t[1]=i=>h.value=i),selectedUnlinkItemIds:p.value,"onUpdate:selectedUnlinkItemIds":t[2]||(t[2]=i=>p.value=i),searchResults:k.value,"is-searching":y.value,"onUpdate:searchKeyword":t[3]||(t[3]=i=>{U.value=i,x(D)(i)})},null,8,["purchase","invoice","unlinkedItems","editableLinkedItems","products","selectedLinkItemIds","selectedUnlinkItemIds","searchResults","is-searching"])]))],64))}};export{Le as default};
