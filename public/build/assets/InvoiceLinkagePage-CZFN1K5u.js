import{y as E,x as o,u as h,C as j,H as z,z as J,j as R,Y as q,g,o as I,a as k,d as T,h as x,F as B,s as d}from"./app-B5O1DEgc.js";import{u as K}from"./useActionLoading-f6xSxY_f.js";import{l as Q}from"./lodash-BDbJNtBq.js";import V from"./MobileChecking-BP2Sodtb.js";import W from"./DesktopChecking-Vz0pjpP9.js";import"./BottomSheet-D-oFX2bz.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./html5-qrcode-scanner-Dc90e2ja.js";import"./AuthenticatedLayout-C7OteFIt.js";import"./useSidebar-DQ6TO2e-.js";import"./PrimaryButton-Biqc0fYN.js";import"./SecondaryButton-BWDFc12P.js";import"./search-CtN9-HoY.js";import"./TextInput-BuE2AqkG.js";const G={key:0},H={key:1},me={__name:"InvoiceLinkagePage",props:{purchase:Object,invoice:Object,unlinkedItems:Array,linkedItems:Array,products:{type:Array,default:()=>[]}},setup(r){const i=r,{isActionLoading:a}=K(),s=E(),n=o(!1),w=o(window.innerWidth<1024),S=()=>{w.value=window.innerWidth<1024},m=o([]),v=o([]),l=o([]),y=o(""),p=o([]),f=o(!1),b=h({ids:[],type:"link"}),L=h({product_id:[],type:"create"}),F=h({item_ids:[]}),A=h({items:[]});j(()=>{l.value=JSON.parse(JSON.stringify(i.linkedItems)),window.addEventListener("resize",S)}),z(()=>window.removeEventListener("resize",S)),J(()=>i.linkedItems,e=>{l.value=JSON.parse(JSON.stringify(e))},{deep:!0});const N=R(()=>l.value.reduce((e,t)=>{const u=(t.quantity||0)*(t.purchase_price||0);return e+u},0)),D=(e=null)=>{let t=[];if(e?t=Array.isArray(e)?e:[e]:t=m.value,t.length===0){s.error("Pilih minimal satu item untuk ditautkan.");return}b.ids=t,a.value=!0,n.value=!0,b.post(route("purchases.linkItems",{purchase:i.purchase.id,invoice:i.invoice.id}),{preserveScroll:!0,onSuccess:()=>{s.success(`${t.length} item berhasil ditautkan.`),m.value=[],d.visit(window.location.href,{preserveScroll:!0,preserveState:!1})},onError:u=>{s.error("Terjadi kesalahan pada server."),console.error(u)},onFinish:()=>{n.value=!1,a.value=!1}})},P=(e=null)=>{let t=[];if(e?t=Array.isArray(e)?e:[e]:t=v.value,t.length===0){s.error("Pilih minimal satu item untuk dilepaskan.");return}F.item_ids=t,a.value=!0,n.value=!0,F.put(route("purchases.unlinkItems",{purchase:i.purchase.id,invoice:i.invoice.id}),{preserveScroll:!0,onSuccess:()=>{s.warning(`${t.length} item dilepaskan.`),v.value=[],d.visit(window.location.href,{preserveScroll:!0,preserveState:!1})},onFinish:()=>{n.value=!1,a.value=!1}})},M=e=>{if(l.value.some(u=>u.product_id===e.id)){s.warning("Produk ini sudah ada di daftar. Gunakan fitur edit untuk mengubah Qty.");return}L.product_id=[e.id],a.value=!0,n.value=!0,L.post(route("purchases.linkItems",{purchase:i.purchase.id,invoice:i.invoice.id}),{preserveScroll:!0,onSuccess:()=>{s.success("Produk tambahan berhasil dimasukkan."),d.visit(window.location.href,{preserveScroll:!0,preserveState:!1})},onFinish:()=>{n.value=!1,a.value=!1,y.value="",p.value=[]}})},$=()=>{if(l.value.some(e=>e.quantity<0)){s.error("Qty tidak boleh minus.");return}A.items=l.value,a.value=!0,n.value=!0,A.put(route("purchases.updateLinkedItemDetails",{purchase:i.purchase.id,invoice:i.invoice.id}),{preserveScroll:!0,onSuccess:()=>{s.success("Data berhasil diperbarui!"),d.reload({only:["linkedItems"]})},onFinish:()=>{n.value=!1,a.value=!1}})},O=()=>{if(i.invoice.status!=="validated"){if(N.value!==i.invoice.total_amount){s.error(`Total nominal (${N.value}) tidak sesuai dengan Target Nota (${i.invoice.total_amount}).`);return}confirm("Apakah Anda yakin data sudah benar? Aksi ini tidak bisa dibatalkan.")&&(a.value=!0,n.value=!0,d.put(route("purchases.validateInvoice",{purchase:i.purchase.id,invoice:i.invoice.id}),{},{preserveScroll:!0,onSuccess:()=>{s.success("Invoice Validated!"),d.visit(route("purchases.validate",i.purchase.id),{preserveScroll:!0,preserveState:!1})},onFinish:()=>{n.value=!1,a.value=!1}}))}},C=Q.throttle(e=>{if(e.length<2){p.value=[];return}f.value=!0,p.value=i.products.filter(t=>t.name.toLowerCase().includes(e.toLowerCase())||t.code.toLowerCase().includes(e.toLowerCase())).slice(0,5),f.value=!1},300),U={validateInvoice:O,addNewSubstituteItem:M,handleSearchNewItem:C,saveCorrections:$,submitUnlinkage:P,submitLinkage:D,formatRupiah:e=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(e),formatTanggal:e=>e?new Date(e).toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"}):"-"};return(e,t)=>{const u=q("ImageModal");return I(),g(B,null,[k(u,{show:e.showImageModal,imageUrl:e.selectedImageUrl,productName:e.selectedInvoiceCode,onClose:t[0]||(t[0]=c=>e.showImageModal=!1)},null,8,["show","imageUrl","productName"]),k(T(x),{title:`Invoice #${r.invoice.invoice_number}`},null,8,["title"]),w.value?(I(),g("div",G,[k(V,{invoice:r.invoice,unlinkedItems:r.unlinkedItems,linkedItems:r.linkedItems,products:r.products,actions:U},null,8,["invoice","unlinkedItems","linkedItems","products"])])):(I(),g("div",H,[k(W,{invoice:r.invoice,"unlinked-items":r.unlinkedItems,"linked-items":l.value,products:r.products,actions:U,"selected-link-ids":m.value,"onUpdate:selectedLinkIds":t[1]||(t[1]=c=>m.value=c),"selected-unlink-ids":v.value,"onUpdate:selectedUnlinkIds":t[2]||(t[2]=c=>v.value=c),"search-results":p.value,"is-searching":f.value,"onUpdate:searchKeyword":t[3]||(t[3]=c=>{y.value=c,T(C)(c)})},null,8,["invoice","unlinked-items","linked-items","products","selected-link-ids","selected-unlink-ids","search-results","is-searching"])]))],64)}}};export{me as default};
