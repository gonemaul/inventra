import{Q as O,V as we,y as ye,u as Te,x as Y,E as Ie,z as je,j as E,R as qe,g as C,o as N,a as j,d as i,h as Re,w as L,b as d,k as te,A as re,t as A,l as Fe,f as Oe,n as Ee,i as Ce,F as Ne}from"./app-OOVJa1pD.js";import{P as De}from"./PrimaryButton-cGu7IqtH.js";import{_ as ae}from"./InputLabel-BnmNEvwx.js";import Le from"./ProductSearch-B__rWWQg.js";import Ae from"./SaleTable-CsHGASjn.js";import{u as Ge}from"./useActionLoading-1e1XIs5r.js";import{_ as Me}from"./AuthenticatedLayout-CL35wTeb.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";var G,ne;function _e(){if(ne)return G;ne=1;function a(n){var l=typeof n;return n!=null&&(l=="object"||l=="function")}return G=a,G}var M,oe;function Pe(){if(oe)return M;oe=1;var a=typeof O=="object"&&O&&O.Object===Object&&O;return M=a,M}var P,se;function xe(){if(se)return P;se=1;var a=Pe(),n=typeof self=="object"&&self&&self.Object===Object&&self,l=a||n||Function("return this")();return P=l,P}var Q,ie;function Qe(){if(ie)return Q;ie=1;var a=xe(),n=function(){return a.Date.now()};return Q=n,Q}var U,le;function Ue(){if(le)return U;le=1;var a=/\s/;function n(l){for(var t=l.length;t--&&a.test(l.charAt(t)););return t}return U=n,U}var V,ce;function Ve(){if(ce)return V;ce=1;var a=Ue(),n=/^\s+/;function l(t){return t&&t.slice(0,a(t)+1).replace(n,"")}return V=l,V}var $,de;function ve(){if(de)return $;de=1;var a=xe(),n=a.Symbol;return $=n,$}var B,ue;function $e(){if(ue)return B;ue=1;var a=ve(),n=Object.prototype,l=n.hasOwnProperty,t=n.toString,o=a?a.toStringTag:void 0;function y(b){var m=l.call(b,o),h=b[o];try{b[o]=void 0;var s=!0}catch{}var f=t.call(b);return s&&(m?b[o]=h:delete b[o]),f}return B=y,B}var z,me;function Be(){if(me)return z;me=1;var a=Object.prototype,n=a.toString;function l(t){return n.call(t)}return z=l,z}var W,fe;function ze(){if(fe)return W;fe=1;var a=ve(),n=$e(),l=Be(),t="[object Null]",o="[object Undefined]",y=a?a.toStringTag:void 0;function b(m){return m==null?m===void 0?o:t:y&&y in Object(m)?n(m):l(m)}return W=b,W}var H,ge;function We(){if(ge)return H;ge=1;function a(n){return n!=null&&typeof n=="object"}return H=a,H}var K,pe;function He(){if(pe)return K;pe=1;var a=ze(),n=We(),l="[object Symbol]";function t(o){return typeof o=="symbol"||n(o)&&a(o)==l}return K=t,K}var J,be;function Ke(){if(be)return J;be=1;var a=Ve(),n=_e(),l=He(),t=NaN,o=/^[-+]0x[0-9a-f]+$/i,y=/^0b[01]+$/i,b=/^0o[0-7]+$/i,m=parseInt;function h(s){if(typeof s=="number")return s;if(l(s))return t;if(n(s)){var f=typeof s.valueOf=="function"?s.valueOf():s;s=n(f)?f+"":f}if(typeof s!="string")return s===0?s:+s;s=a(s);var _=y.test(s);return _||b.test(s)?m(s.slice(2),_?2:8):o.test(s)?t:+s}return J=h,J}var X,he;function Je(){if(he)return X;he=1;var a=_e(),n=Qe(),l=Ke(),t="Expected a function",o=Math.max,y=Math.min;function b(m,h,s){var f,_,T,v,g,x,S=0,q=!1,k=!1,R=!0;if(typeof m!="function")throw new TypeError(t);h=l(h)||0,a(s)&&(q=!!s.leading,k="maxWait"in s,T=k?o(l(s.maxWait)||0,h):T,R="trailing"in s?!!s.trailing:R);function e(u){var I=f,F=_;return f=_=void 0,S=u,v=m.apply(F,I),v}function r(u){return S=u,g=setTimeout(c,h),q?e(u):v}function p(u){var I=u-x,F=u-S,ee=h-I;return k?y(ee,T-F):ee}function w(u){var I=u-x,F=u-S;return x===void 0||I>=h||I<0||k&&F>=T}function c(){var u=n();if(w(u))return Z(u);g=setTimeout(c,p(u))}function Z(u){return g=void 0,R&&f?e(u):(f=_=void 0,v)}function ke(){g!==void 0&&clearTimeout(g),S=0,f=x=_=g=void 0}function Se(){return g===void 0?v:Z(n())}function D(){var u=n(),I=w(u);if(f=arguments,_=this,x=u,I){if(g===void 0)return r(x);if(k)return clearTimeout(g),g=setTimeout(c,h),e(x)}return g===void 0&&(g=setTimeout(c,h)),v}return D.cancel=ke,D.flush=Se,D}return X=b,X}var Xe=Je();const Ye=we(Xe);function Ze(a){const n=ye(),l="POS_RECAP_DRAFT_V1",t=Te({report_date:a?.sale?.transaction_date||new Date().toISOString().substr(0,10),items:[]}),o=Y([]),y=Y(!1),b=["kg","kilogram","gram","gr","g","ons","ton","kwintal","mg","liter","ltr","l","ml","cc","m3","kubik","galon","meter","mtr","m","cm","mm","m2","yard","kaki","inch","inci"];Ie(()=>{const e=localStorage.getItem(l);let r=[],p="",w=[];if(e)try{const c=JSON.parse(e);c.items&&c.items.length>0&&(r=c.items,p=c.notes||"")}catch{localStorage.removeItem(l)}a?.mode==="edit"&&a.sale?.items?(w=a.sale.items.map(c=>({product_id:c.product_id,code:c.product_snapshot?.code,name:c.product_snapshot?.name,unit:c.product_snapshot?.unit,category:c.product_snapshot?.category,brand:c.product_snapshot?.brand,stock_max:parseFloat(c.product?.stock||0)+parseFloat(c.quantity),image:c.product?.image,selling_price:parseFloat(c.selling_price),is_price_locked:!0,is_total_locked:!0,quantity:parseFloat(c.quantity),subtotal:parseFloat(c.subtotal)})),r.length>0?(t.items=[...w,...r],t.notes=p||a.sale?.notes||"",console.log("Data digabung: Database + Local Storage")):(t.items=w,t.notes=a.sale?.notes||"")):r.length>0&&(t.items=r,t.notes=p)}),je(()=>t.items,e=>{localStorage.setItem(l,JSON.stringify({items:e,notes:t.notes}))},{deep:!0});const m=e=>e&&b.includes(e.toLowerCase()),h=(e,r)=>{m(r)||(e.key==="."||e.key===",")&&e.preventDefault()},s=e=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(e),f=E(()=>t.items.some(e=>parseFloat(e.quantity)<=0)),_=E(()=>t.items.some(e=>parseFloat(e.quantity)>parseFloat(e.stock_max))),T=e=>{if(parseFloat(e.stock)<=0){n.error("Stok habis. Tidak bisa ditambahkan.");return}const r=t.items.find(p=>p.product_id===e.id);if(r){if(r.quantity+1>e.stock){n.error("Melebihi sisa stok!");return}r.quantity++,g(r)}else t.items.push({product_id:e.id,code:e.code,name:e.name,unit:e.unit,category:e.category?.name||"-",brand:e.brand||"-",stock_max:parseFloat(e.stock),image:e.image,selling_price:parseFloat(e.price),is_price_locked:!0,is_total_locked:!0,quantity:1,subtotal:parseFloat(e.price)})},v=e=>t.items.splice(e,1),g=e=>{const r=parseFloat(e.quantity)||0,p=parseFloat(e.selling_price)||0;e.subtotal=Math.round(r*p)},x=e=>{const r=parseFloat(e.subtotal)||0,p=parseFloat(e.selling_price)||0;if(p>0){let w=r/p;e.quantity=m(e.unit)?parseFloat(w.toFixed(4)):Math.round(w)}},S=Ye(async e=>{if(!e){o.value=[];return}y.value=!0;try{const r=await qe.get(route("sales.search-product"),{params:{query:e}});o.value=r.data,console.log(r)}catch(r){console.error(r)}finally{y.value=!1}},300),q=()=>{if(t.items.length===0){n.error("Keranjang masih kosong!");return}if(f.value){n.error("Ada produk dengan Qty 0. Mohon isi jumlah barang atau hapus dari list.");return}if(_.value){const e=t.items.find(r=>parseFloat(r.quantity)>parseFloat(r.stock_max));n.error(`Stok tidak cukup untuk produk: ${e.name}. (Sisa: ${e.stock_max})`);return}a?.mode==="edit"?t.put(route("sales.update",a.sale.id),{onSuccess:()=>{localStorage.removeItem(l),t.reset(),t.items=[]},onError:e=>{console.error(e),n.error("Gagal menyimpan. Periksa inputan.")}}):a?.mode==="create"&&(console.log("store"),t.post(route("sales.store"),{onSuccess:()=>{localStorage.removeItem(l),t.reset(),t.items=[]},onError:e=>{console.error(e),n.error("Gagal menyimpan. Periksa inputan.")}}))},k=E(()=>t.items.reduce((e,r)=>e+(parseFloat(r.quantity)||0),0)),R=E(()=>t.items.reduce((e,r)=>e+(parseFloat(r.subtotal)||0),0));return{form:t,searchResults:o,isLoadingSearch:y,addItem:T,removeItem:v,handleSearch:S,calculateSubtotal:g,calculateQty:x,checkIntegerInput:h,isDecimalAllowed:m,formatCurrency:s,totalQty:k,grandTotal:R,hasInvalidQty:f,hasStockError:_,submitForm:q}}const et={class:"flex flex-col h-screen overflow-hidden bg-gray-50"},tt={class:"relative z-20 flex flex-col items-center justify-between flex-shrink-0 gap-4 px-6 py-4 bg-white border-b border-gray-200 shadow-sm md:flex-row"},rt={class:"flex items-center flex-1 w-full gap-4"},at={class:"w-40"},nt={class:"flex-1"},ot={class:"flex items-center justify-between order-2 w-full h-auto gap-2 px-0 py-2 mt-2 border-l-0 border-r border-gray-200 rounded md:flex-row md:gap-8 md:px-8 md:border-l md:h-12 md:w-auto md:justify-start md:py-0 md:order-none bg-gray-50 md:bg-transparent md:rounded-none md:mt-0"},st={class:"flex-1 text-center md:flex-none"},it={class:"text-base font-bold leading-none text-gray-700 md:text-lg"},lt={class:"flex-1 pl-2 text-center border-l border-gray-200 md:flex-none md:border-0 md:pl-0"},ct={class:"text-base font-bold leading-none text-gray-700 md:text-lg"},dt={class:"order-1 w-full text-right md:w-auto md:order-none"},ut={class:"text-2xl font-black leading-none tracking-tight text-indigo-600 md:text-3xl"},mt={class:"relative flex flex-col flex-1 min-h-0"},ft={class:"z-10 p-4 pb-0"},gt={class:"flex flex-col flex-1 p-4 pt-2 overflow-hidden"},pt={class:"z-20 flex justify-end flex-shrink-0 gap-3 p-4 bg-white border-t border-gray-200"},bt={key:0,class:"w-5 h-5 text-white animate-spin",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},ht={key:1},yt={key:2},jt={__name:"form",props:{sale:Object,mode:String},setup(a){const n=a;ye();const{isActionLoading:l}=Ge(),t=Y(null),{form:o,grandTotal:y,totalQty:b,formatCurrency:m,handleSearch:h,searchResults:s,isLoadingSearch:f,addItem:_,removeItem:T,checkIntegerInput:v,isDecimalAllowed:g,calculateSubtotal:x,calculateQty:S,hasInvalidQty:q,hasStockError:k,submitForm:R}=Ze(n);return console.log(o),l.value=o.processing,(e,r)=>(N(),C(Ne,null,[j(i(Re),{title:"Input Rekap Penjualan"}),j(Me,{showHeader:!1,showSidebar:!1},{default:L(()=>[d("div",et,[d("div",tt,[d("div",rt,[d("div",at,[j(ae,{value:"Tanggal Laporan",class:"mb-1 text-xs font-bold text-gray-500 uppercase"}),te(d("input",{type:"date","onUpdate:modelValue":r[0]||(r[0]=p=>i(o).report_date=p),class:"w-full text-sm font-bold border-gray-300 rounded focus:ring-indigo-500"},null,512),[[re,i(o).report_date]])]),d("div",nt,[j(ae,{value:"Catatan",class:"mb-1 text-xs font-bold text-gray-500 uppercase"}),te(d("input",{type:"text","onUpdate:modelValue":r[1]||(r[1]=p=>i(o).notes=p),class:"w-full text-sm border-gray-300 rounded focus:ring-indigo-500",placeholder:"Shift pagi, cuaca hujan..."},null,512),[[re,i(o).notes]])])]),d("div",ot,[d("div",st,[r[2]||(r[2]=d("div",{class:"text-[9px] md:text-[10px] text-gray-400 uppercase font-bold tracking-wider"}," Item ",-1)),d("div",it,A(i(o).items.length),1)]),d("div",lt,[r[3]||(r[3]=d("div",{class:"text-[9px] md:text-[10px] text-gray-400 uppercase font-bold tracking-wider"}," Qty ",-1)),d("div",ct,A(i(b)),1)])]),d("div",dt,[r[4]||(r[4]=d("div",{class:"text-[10px] text-gray-400 uppercase tracking-widest font-bold mb-1"}," Estimasi Omset ",-1)),d("div",ut,A(i(m)(i(y))),1)])]),d("div",mt,[d("div",ft,[j(Le,{ref_key:"productSearchRef",ref:t,"search-results":i(s),"is-loading":i(f),onSearch:i(h),onAdd:i(_)},null,8,["search-results","is-loading","onSearch","onAdd"])]),d("div",gt,[j(Ae,{items:i(o).items,"is-decimal-allowed":i(g),"check-integer":i(v),onRemove:i(T),onUpdateCalc:i(x),onUpdateQty:i(S)},null,8,["items","is-decimal-allowed","check-integer","onRemove","onUpdateCalc","onUpdateQty"])]),d("div",pt,[j(i(Fe),{href:e.route("sales.index"),class:"px-6 py-3 text-sm font-medium text-gray-700 transition bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"},{default:L(()=>[...r[5]||(r[5]=[Oe(" Kembali ",-1)])]),_:1},8,["href"]),j(De,{disabled:i(o).items.length===0||i(o).processing||i(q)||i(k),class:Ee([{"opacity-50  cursor-not-allowed":i(o).items.length===0||i(o).processing||i(q)||i(k)},"flex items-center gap-2 px-8 py-3 text-base shadow-lg"]),onClick:i(R)},{default:L(()=>[i(o).processing?(N(),C("svg",bt,[...r[6]||(r[6]=[d("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),d("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):Ce("",!0),i(o).processing?(N(),C("span",ht,"Menyimpan...")):(N(),C("span",yt,"Simpan Rekap"))]),_:1},8,["disabled","class","onClick"])])])])]),_:1})],64))}};export{jt as default};
