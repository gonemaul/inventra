import{Q as O,R as Te,G as he,u as we,m as X,H as Ie,s as je,j as E,P as qe,g as C,o as N,a as j,b as c,d as i,h as Re,k as ee,A as te,t as L,w as re,f as Fe,l as Oe,i as Ee,n as Ce,F as Ne}from"./app-DwOZ8O7W.js";import{P as Ae}from"./PrimaryButton-BQIY3AiW.js";import{_ as ae}from"./InputLabel-DbFrkpph.js";import Le from"./ProductSearch-B8SHMueL.js";import De from"./SaleTable-CKM6eXK1.js";import{u as Ge}from"./useActionLoading-D41ljnOE.js";import"./useSidebar-BYtjcE5l.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";var D,ne;function _e(){if(ne)return D;ne=1;function n(a){var l=typeof a;return a!=null&&(l=="object"||l=="function")}return D=n,D}var G,oe;function Me(){if(oe)return G;oe=1;var n=typeof O=="object"&&O&&O.Object===Object&&O;return G=n,G}var M,se;function xe(){if(se)return M;se=1;var n=Me(),a=typeof self=="object"&&self&&self.Object===Object&&self,l=n||a||Function("return this")();return M=l,M}var P,ie;function Pe(){if(ie)return P;ie=1;var n=xe(),a=function(){return n.Date.now()};return P=a,P}var Q,le;function Qe(){if(le)return Q;le=1;var n=/\s/;function a(l){for(var r=l.length;r--&&n.test(l.charAt(r)););return r}return Q=a,Q}var U,ce;function Ue(){if(ce)return U;ce=1;var n=Qe(),a=/^\s+/;function l(r){return r&&r.slice(0,n(r)+1).replace(a,"")}return U=l,U}var B,ue;function ve(){if(ue)return B;ue=1;var n=xe(),a=n.Symbol;return B=a,B}var V,de;function Be(){if(de)return V;de=1;var n=ve(),a=Object.prototype,l=a.hasOwnProperty,r=a.toString,o=n?n.toStringTag:void 0;function b(g){var d=l.call(g,o),p=g[o];try{g[o]=void 0;var s=!0}catch{}var m=r.call(g);return s&&(d?g[o]=p:delete g[o]),m}return V=b,V}var $,me;function Ve(){if(me)return $;me=1;var n=Object.prototype,a=n.toString;function l(r){return a.call(r)}return $=l,$}var z,fe;function $e(){if(fe)return z;fe=1;var n=ve(),a=Be(),l=Ve(),r="[object Null]",o="[object Undefined]",b=n?n.toStringTag:void 0;function g(d){return d==null?d===void 0?o:r:b&&b in Object(d)?a(d):l(d)}return z=g,z}var W,ge;function ze(){if(ge)return W;ge=1;function n(a){return a!=null&&typeof a=="object"}return W=n,W}var H,pe;function We(){if(pe)return H;pe=1;var n=$e(),a=ze(),l="[object Symbol]";function r(o){return typeof o=="symbol"||a(o)&&n(o)==l}return H=r,H}var K,be;function He(){if(be)return K;be=1;var n=Ue(),a=_e(),l=We(),r=NaN,o=/^[-+]0x[0-9a-f]+$/i,b=/^0b[01]+$/i,g=/^0o[0-7]+$/i,d=parseInt;function p(s){if(typeof s=="number")return s;if(l(s))return r;if(a(s)){var m=typeof s.valueOf=="function"?s.valueOf():s;s=a(m)?m+"":m}if(typeof s!="string")return s===0?s:+s;s=n(s);var y=b.test(s);return y||g.test(s)?d(s.slice(2),y?2:8):o.test(s)?r:+s}return K=p,K}var J,ye;function Ke(){if(ye)return J;ye=1;var n=_e(),a=Pe(),l=He(),r="Expected a function",o=Math.max,b=Math.min;function g(d,p,s){var m,y,S,x,f,_,k=0,w=!1,v=!1,I=!0;if(typeof d!="function")throw new TypeError(r);p=l(p)||0,n(s)&&(w=!!s.leading,v="maxWait"in s,S=v?o(l(s.maxWait)||0,p):S,I="trailing"in s?!!s.trailing:I);function e(u){var T=m,R=y;return m=y=void 0,k=u,x=d.apply(R,T),x}function t(u){return k=u,f=setTimeout(F,p),w?e(u):x}function h(u){var T=u-_,R=u-k,Z=p-T;return v?b(Z,S-R):Z}function q(u){var T=u-_,R=u-k;return _===void 0||T>=p||T<0||v&&R>=S}function F(){var u=a();if(q(u))return Y(u);f=setTimeout(F,h(u))}function Y(u){return f=void 0,I&&m?e(u):(m=y=void 0,x)}function ke(){f!==void 0&&clearTimeout(f),k=0,m=_=y=f=void 0}function Se(){return f===void 0?x:Y(a())}function A(){var u=a(),T=q(u);if(m=arguments,y=this,_=u,T){if(f===void 0)return t(_);if(v)return clearTimeout(f),f=setTimeout(F,p),e(_)}return f===void 0&&(f=setTimeout(F,p)),x}return A.cancel=ke,A.flush=Se,A}return J=g,J}var Je=Ke();const Xe=Te(Je);function Ye(n){const a=he(),l="POS_RECAP_DRAFT_V1",r=we({report_date:n?.sale?.transaction_date||new Date().toISOString().substr(0,10),notes:n?.sale?.notes||"",items:n?.sale?.items?n.sale.items.map(e=>({product_id:e.product_id,code:e.product_snapshot?.code,name:e.product_snapshot?.name,unit:e.product_snapshot?.unit,stock_max:parseFloat(e.product?.stock||0)+parseFloat(e.quantity),image:e.product?.image,selling_price:parseFloat(e.selling_price),is_price_locked:!0,quantity:parseFloat(e.quantity),subtotal:parseFloat(e.subtotal)})):[]}),o=X([]),b=X(!1),g=["kg","kilogram","gram","gr","g","ons","ton","kwintal","mg","liter","ltr","l","ml","cc","m3","kubik","galon","meter","mtr","m","cm","mm","m2","yard","kaki","inch","inci"];Ie(()=>{const e=localStorage.getItem(l);if(e)try{const t=JSON.parse(e);t.items&&t.items.length>0&&(r.items=t.items,r.notes=t.notes||"")}catch{localStorage.removeItem(l)}}),je(()=>r.items,e=>{localStorage.setItem(l,JSON.stringify({items:e,notes:r.notes}))},{deep:!0});const d=e=>e&&g.includes(e.toLowerCase()),p=(e,t)=>{d(t)||(e.key==="."||e.key===",")&&e.preventDefault()},s=e=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(e),m=E(()=>r.items.some(e=>parseFloat(e.quantity)<=0)),y=E(()=>r.items.some(e=>parseFloat(e.quantity)>parseFloat(e.stock_max))),S=e=>{if(parseFloat(e.stock)<=0){a.error("Stok habis. Tidak bisa ditambahkan.");return}const t=r.items.find(h=>h.product_id===e.id);if(t){if(t.quantity+1>e.stock){a.error("Melebihi sisa stok!");return}t.quantity++,f(t)}else r.items.push({product_id:e.id,code:e.code,name:e.name,unit:e.unit,category:e.category?.name||"-",brand:e.brand||"-",stock_max:parseFloat(e.stock),image:e.image,selling_price:parseFloat(e.price),is_price_locked:!0,is_total_locked:!0,quantity:1,subtotal:parseFloat(e.price)})},x=e=>r.items.splice(e,1),f=e=>{const t=parseFloat(e.quantity)||0,h=parseFloat(e.selling_price)||0;e.subtotal=Math.round(t*h)},_=e=>{const t=parseFloat(e.subtotal)||0,h=parseFloat(e.selling_price)||0;if(h>0){let q=t/h;e.quantity=d(e.unit)?parseFloat(q.toFixed(4)):Math.round(q)}},k=Xe(async e=>{if(!e){o.value=[];return}b.value=!0;try{const t=await qe.get(route("sales.search-product"),{params:{query:e}});o.value=t.data,console.log(t)}catch(t){console.error(t)}finally{b.value=!1}},300),w=()=>{if(r.items.length===0){a.error("Keranjang masih kosong!");return}if(m.value){a.error("Ada produk dengan Qty 0. Mohon isi jumlah barang atau hapus dari list.");return}if(y.value){const e=r.items.find(t=>parseFloat(t.quantity)>parseFloat(t.stock_max));a.error(`Stok tidak cukup untuk produk: ${e.name}. (Sisa: ${e.stock_max})`);return}n?.mode==="edit"?r.put(route("sales.update",n.sale.id),{onSuccess:()=>{localStorage.removeItem(l),r.reset(),r.items=[]},onError:e=>{console.error(e),a.error("Gagal menyimpan. Periksa inputan.")}}):r.post(route("sales.store"),{onSuccess:()=>{localStorage.removeItem(l),r.reset(),r.items=[]},onError:e=>{console.error(e),a.error("Gagal menyimpan. Periksa inputan.")}})},v=E(()=>r.items.reduce((e,t)=>e+(parseFloat(t.quantity)||0),0)),I=E(()=>r.items.reduce((e,t)=>e+(parseFloat(t.subtotal)||0),0));return{form:r,searchResults:o,isLoadingSearch:b,addItem:S,removeItem:x,handleSearch:k,calculateSubtotal:f,calculateQty:_,checkIntegerInput:p,isDecimalAllowed:d,formatCurrency:s,totalQty:v,grandTotal:I,hasInvalidQty:m,hasStockError:y,submitForm:w}}const Ze={class:"flex flex-col h-screen overflow-hidden bg-gray-50"},et={class:"relative z-20 flex flex-col items-center justify-between flex-shrink-0 gap-4 px-6 py-4 bg-white border-b border-gray-200 shadow-sm md:flex-row"},tt={class:"flex items-center flex-1 w-full gap-4"},rt={class:"w-40"},at={class:"flex-1"},nt={class:"flex items-center justify-between order-2 w-full h-auto gap-2 px-0 py-2 mt-2 border-l-0 border-r border-gray-200 rounded md:flex-row md:gap-8 md:px-8 md:border-l md:h-12 md:w-auto md:justify-start md:py-0 md:order-none bg-gray-50 md:bg-transparent md:rounded-none md:mt-0"},ot={class:"flex-1 text-center md:flex-none"},st={class:"text-base font-bold leading-none text-gray-700 md:text-lg"},it={class:"flex-1 pl-2 text-center border-l border-gray-200 md:flex-none md:border-0 md:pl-0"},lt={class:"text-base font-bold leading-none text-gray-700 md:text-lg"},ct={class:"order-1 w-full text-right md:w-auto md:order-none"},ut={class:"text-2xl font-black leading-none tracking-tight text-indigo-600 md:text-3xl"},dt={class:"relative flex flex-col flex-1 min-h-0"},mt={class:"z-10 p-4 pb-0"},ft={class:"flex flex-col flex-1 p-4 pt-2 overflow-hidden"},gt={class:"z-20 flex justify-end flex-shrink-0 gap-3 p-4 bg-white border-t border-gray-200"},pt={key:0,class:"w-5 h-5 text-white animate-spin",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},bt={key:1},yt={key:2},It={__name:"form",props:{sale:Object,mode:String},setup(n){const a=n;he();const{isActionLoading:l}=Ge(),r=X(null),{form:o,grandTotal:b,totalQty:g,formatCurrency:d,handleSearch:p,searchResults:s,isLoadingSearch:m,addItem:y,removeItem:S,checkIntegerInput:x,isDecimalAllowed:f,calculateSubtotal:_,calculateQty:k,hasInvalidQty:w,hasStockError:v,submitForm:I}=Ye(a);return l.value=o.processing,(e,t)=>(N(),C(Ne,null,[j(i(Re),{title:"Input Rekap Penjualan"}),c("div",Ze,[c("div",et,[c("div",tt,[c("div",rt,[j(ae,{value:"Tanggal Laporan",class:"mb-1 text-xs font-bold text-gray-500 uppercase"}),ee(c("input",{type:"date","onUpdate:modelValue":t[0]||(t[0]=h=>i(o).report_date=h),class:"w-full text-sm font-bold border-gray-300 rounded focus:ring-indigo-500"},null,512),[[te,i(o).report_date]])]),c("div",at,[j(ae,{value:"Catatan",class:"mb-1 text-xs font-bold text-gray-500 uppercase"}),ee(c("input",{type:"text","onUpdate:modelValue":t[1]||(t[1]=h=>i(o).notes=h),class:"w-full text-sm border-gray-300 rounded focus:ring-indigo-500",placeholder:"Shift pagi, cuaca hujan..."},null,512),[[te,i(o).notes]])])]),c("div",nt,[c("div",ot,[t[2]||(t[2]=c("div",{class:"text-[9px] md:text-[10px] text-gray-400 uppercase font-bold tracking-wider"}," Item ",-1)),c("div",st,L(i(o).items.length),1)]),c("div",it,[t[3]||(t[3]=c("div",{class:"text-[9px] md:text-[10px] text-gray-400 uppercase font-bold tracking-wider"}," Qty ",-1)),c("div",lt,L(i(g)),1)])]),c("div",ct,[t[4]||(t[4]=c("div",{class:"text-[10px] text-gray-400 uppercase tracking-widest font-bold mb-1"}," Estimasi Omset ",-1)),c("div",ut,L(i(d)(i(b))),1)])]),c("div",dt,[c("div",mt,[j(Le,{ref_key:"productSearchRef",ref:r,"search-results":i(s),"is-loading":i(m),onSearch:i(p),onAdd:i(y)},null,8,["search-results","is-loading","onSearch","onAdd"])]),c("div",ft,[j(De,{items:i(o).items,"is-decimal-allowed":i(f),"check-integer":i(x),onRemove:i(S),onUpdateCalc:i(_),onUpdateQty:i(k)},null,8,["items","is-decimal-allowed","check-integer","onRemove","onUpdateCalc","onUpdateQty"])]),c("div",gt,[j(i(Oe),{href:e.route("sales.index"),class:"px-6 py-3 text-sm font-medium text-gray-700 transition bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"},{default:re(()=>[...t[5]||(t[5]=[Fe(" Kembali ",-1)])]),_:1},8,["href"]),j(Ae,{disabled:i(o).items.length===0||i(o).processing||i(w)||i(v),class:Ce([{"opacity-50  cursor-not-allowed":i(o).items.length===0||i(o).processing||i(w)||i(v)},"flex items-center gap-2 px-8 py-3 text-base shadow-lg"]),onClick:i(I)},{default:re(()=>[i(o).processing?(N(),C("svg",pt,[...t[6]||(t[6]=[c("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),c("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):Ee("",!0),i(o).processing?(N(),C("span",bt,"Menyimpan...")):(N(),C("span",yt,"Simpan Rekap"))]),_:1},8,["disabled","class","onClick"])])])])],64))}};export{It as default};
