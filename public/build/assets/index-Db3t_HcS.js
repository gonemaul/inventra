import{q as pe,v as l,D as C,u as ye,K as ae,x as ve,a as me,S as ge,l as ee,o as Q,e as q,d as he,p as te,f as u,g as r,i as be,j as ke,t as ce,k as _e,F as we}from"./vendor-core-B46KUNyc.js";import{j as xe}from"./vendor-common-GpUWqhKr.js";import Se from"./ConfirmSubmit-BnBPupiD.js";import Ce from"./Cart-aTzTcBmR.js";import{_ as qe}from"./BarcodeScanner-BWk-Obnv.js";import Fe from"./FilterProduct-Dg1UPDm9.js";import Me from"./ProductDetailModal-C3VMI-gp.js";import Te from"./ProductComparisonModal-Bm8S7CqY.js";import Ae from"./TransactionSuccessModal-DAfN2o5G.js";import Pe from"./ProductList-16bvGSpf.js";import De from"./PosQtyModal-CbJjYBo0.js";import"./vendor-charts-Bw6UNgWf.js";import"./BottomSheet-p_YbYltf.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./InputRupiah-B1VRU30-.js";import"./MoneyInput-pdIiFupq.js";import"./vendor-scanner-og__AIM6.js";function Ie(k){const d=pe(),f="POS_REALTIME_DRAFT_V3",m=l([]),h=l(!1),y=l(20),i=l(!0),p=l({search:"",category:"all",subCategory:"all",brand:"all",sort:"default",hideEmptyStock:!0}),_=l([]),F=l(""),b=l([]),w=l(null),T=l([]),z=C(()=>k.mode==="edit"),g=k.sale||null,o=ye({id:g?.id||null,input_type:g?.input_type||"realtime",report_date:g?.transaction_date||(()=>{const e=new Date,s=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),t=String(e.getDate()).padStart(2,"0");return`${s}-${a}-${t}`})(),items:g?.items?.map(e=>{const s=e.product,a=e.product_snapshot||{},t=s?.name||a.name||"Unknown Item",n=s?.code||a.code||"-";let c=s?.category;return!c&&a.category&&(c={name:a.category}),{product_id:e.product_id,code:n,name:t,category:c,unit:s?.unit||(a.unit?{name:a.unit}:null),size:s?.size,stock_max:parseFloat(s?.stock||0)+parseFloat(e.quantity),selling_price:parseFloat(e.selling_price),original_price:parseFloat(e.selling_price),quantity:parseFloat(e.quantity),original_quantity:parseFloat(e.quantity),subtotal:parseFloat(e.subtotal)}})||[],customer_id:g?.customer_id||null,payment_amount:g?parseFloat(g.total_payment):0,change_amount:g?parseFloat(g.change_amount):0,payment_method:g?.payment_method||"cash",discount_type:g?.discount_type||"fixed",discount_value:g?.discount_value||0,notes:g?.notes||""}),M=C(()=>o.items.reduce((e,s)=>e+(parseFloat(s.subtotal)||0),0)),J=C(()=>{const e=parseFloat(o.discount_value)||0;if(e<=0)return 0;if(o.discount_type==="percent"){const s=e>100?100:e;return Math.round(M.value*s/100)}return e>M.value?M.value:e}),A=C(()=>{const e=M.value-J.value,s=e>0?e:0;return s===0&&o.payment_amount>0,s}),H=C(()=>(parseFloat(o.payment_amount)||0)-A.value),se=C(()=>o.payment_method!=="cash"&&o.payment_method!==""?!0:(parseFloat(o.payment_amount)||0)>=A.value),oe=C(()=>o.items.some(e=>e.quantity<=0||isNaN(e.quantity))),K=C(()=>{const e=A.value;if(e<=0)return[];const s=[{label:"Uang Pas",value:e}];if([2e3,5e3,1e4,2e4,5e4,1e5].forEach(t=>{t>e&&!s.find(n=>n.value===t)&&s.push({label:R(t),value:t})}),e>5e4){const t=Math.ceil(e/5e4)*5e4;s.find(n=>n.value===t)||s.push({label:R(t),value:t})}return s.slice(0,4)}),P=e=>{e.unit?.is_decimal===1||(e.quantity=Math.round(e.quantity),e.quantity<1&&(e.quantity=1)),e.quantity>e.stock_max&&(e.quantity=e.stock_max,d.warning(`Stok sisa ${e.stock_max}`)),e.subtotal=Math.round(e.quantity*e.selling_price)},de=e=>{const s=parseFloat(e.subtotal)||0,a=parseFloat(e.selling_price)||0;if(!(a<=0))if(e.unit?.is_decimal===1){let t=s/a;t>e.stock_max&&(t=e.stock_max,e.subtotal=Math.round(t*a),d.warning("Melebihi sisa stok!")),e.quantity=parseFloat(t.toFixed(4))}else confirm(`âš ï¸ Ubah harga satuan agar sesuai total ${R(s)}?`)?e.quantity>0&&(e.selling_price=Math.round(s/e.quantity)):e.subtotal=Math.round(e.quantity*e.selling_price)},B=e=>{e.subtotal=Math.round(e.quantity*e.selling_price)},ne=e=>{const s=["Jasa","Layanan"].includes(e.category?.name);if(!s&&parseFloat(e.stock)<=0){d.error("Stok habis!");return}const a=o.items.find(t=>t.product_id===e.id);if(a){if(s){d.warning(`Jasa "${e.name}" sudah ada di keranjang.`);return}if(a.quantity+1>e.stock){d.warning("Stok maksimal!");return}a.quantity++,P(a)}else{const t=parseFloat(e.selling_price||e.price);o.items.push({product_id:e.id,code:e.code,name:e.name,image_url:e.image_url,category:e.category,unit:e.unit,size:e.size,stock_max:parseFloat(e.stock),selling_price:t,original_price:t,quantity:1,original_quantity:0,subtotal:t,is_service:s})}},D=e=>o.items.splice(e,1),I=(e,s)=>{const a=o.items[e],t=parseFloat(a.quantity)+s;if(t>a.stock_max){d.warning(`Stok sisa ${a.stock_max}`);return}if(t<=0){confirm("Hapus item ini?")&&D(e);return}a.quantity=t,P(a)},j=e=>{o.payment_amount=e.value},U=()=>{o.payment_amount=0},L=()=>{m.value.length&&o.items.forEach(e=>{const s=m.value.find(a=>a.id===e.product_id);if(s){const a=e.original_quantity||0,t=parseFloat(s.stock);e.stock_max=t+a,e.quantity>e.stock_max&&(d.warning(`Stok ${e.name} berubah! Disesuaikan ke max: ${e.stock_max}`),e.quantity=e.stock_max,P(e))}})},S=l(new Map),$=l([]),E=l([]),x=async(e={})=>{const s=y.value,a=e.search||p.value.search,t={query:a,limit:s,category_id:a?"all":p.value.category,product_type_id:a?"all":p.value.subCategory,brand_id:a?"all":p.value.brand,sort:p.value.sort,hide_empty_stock:p.value.hideEmptyStock?1:0,size_id:a?"all":p.value.size||"all"},n=JSON.stringify(t);if(S.value.has(n)){const c=S.value.get(n);Array.isArray(c)?m.value=c:(m.value=c.products,$.value=c.available_brands||[],E.value=c.available_sizes||[],c.products.length<s?i.value=!1:i.value=!0),L()}else h.value=!0;try{const v=(await me.get(route("sales.products.lite"),{params:t})).data;let G=[];Array.isArray(v)?G=v:(G=v.products,$.value=v.available_brands||[],E.value=v.available_sizes||[]),m.value=G,G.length<s?i.value=!1:i.value=!0,S.value.set(n,v),L()}catch(c){console.error("Gagal load produk:",c),S.value.has(n)||d.error("Gagal memuat database produk")}finally{h.value=!1}},W=xe(()=>{y.value=20,i.value=!0,x()},400);ae(()=>p.value,(e,s)=>{e.search!==s.search?(h.value=!0,W()):((e.category!==s.category||e.subCategory!==s.subCategory||e.brand!==s.brand)&&(y.value=20,i.value=!0,m.value=[]),x())},{deep:!0});const Y=C(()=>m.value),N=()=>{!i.value||h.value||(y.value+=12,x())},O=async()=>{try{const e=await me.get(route("sales.products.lite"),{params:{only_services:!0,limit:100}});e.data.products?T.value=e.data.products:Array.isArray(e.data)?T.value=e.data:T.value=[]}catch(e){console.error("Gagal load layanan:",e)}},re=e=>{w.value=e,o.customer_id=e.id,b.value=[],F.value=""};ae(F,e=>{if(!e||!k.customers){b.value=[];return}const s=e.toLowerCase(),a=k.customers.filter(t=>t.name.toLowerCase().includes(s)||t.code.toLowerCase().includes(s));b.value=a.slice(0,5)});const le=e=>{const s=k.customers.find(a=>a.member_code==e||a.phone==e);s?re(s):d.warning("Member tidak ditemukan")},V=()=>{if(z.value)return;const e=localStorage.getItem(f);if(e)try{const s=JSON.parse(e);s.items&&(o.items=s.items),o.payment_amount=s.payment_amount||0,o.payment_method=s.payment_method||"cash",o.notes=s.notes||"",o.discount_type=s.discount_type||"fixed",o.discount_value=s.discount_value||0,s.selectedMember&&(w.value=s.selectedMember,o.customer_id=s.selectedMember.id)}catch{localStorage.removeItem(f)}};ae([()=>o.items,()=>o.customer_id,()=>o.payment_amount,()=>o.discount_value,()=>o.notes],()=>{localStorage.setItem(f,JSON.stringify({items:o.items,customer_id:o.customer_id,payment_amount:o.payment_amount,payment_method:o.payment_method,notes:o.notes,discount_type:o.discount_type,discount_value:o.discount_value,selectedMember:w.value}))},{deep:!0});const ie=(e=!1)=>new Promise((s,a)=>{const t=H.value,n=A.value;o.change_amount=t,o.payment_amount=parseFloat(o.payment_amount);const c={onSuccess:v=>{const fe=(v.props.flash||{}).sale_id;z.value||(x(),localStorage.removeItem(f),o.reset(),o.items=[],w.value=null),s({success:!0,saleId:fe,change:t,total:n})},onError:v=>{console.error(v),d.error("Gagal memproses transaksi"),a(v)},onFinish:()=>{}};z.value?o.transform(v=>({...v})).put(route("sales.update",o.id),c):o.transform(v=>({...v,print_invoice:e})).post(route("sales.pos.store"),c)}),R=e=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(e),ue=e=>{const s=_.value.findIndex(a=>a.id===e.id);if(s!==-1)_.value.splice(s,1);else{if(_.value.length>=5){d.warning("Maksimal 5 produk untuk perbandingan.");return}_.value.push(e)}},X=()=>{_.value=[]},Z=e=>_.value.some(s=>s.id===e);return ve(()=>{if(x(),O(),V(),z.value){const e=new Date().toISOString().slice(0,10);o.report_date=e}}),{form:o,filterState:p,allProducts:m,filteredProducts:Y,isFetchingData:h,compareList:_,serviceProducts:T,dynamicBrands:$,dynamicSizes:E,memberSearch:F,memberSearchResults:b,selectedMember:w,subTotal:M,discountAmount:J,grandTotal:A,changeAmount:H,isPaymentSufficient:se,hasInvalidQty:oe,moneySuggestions:K,loadMoreProducts:N,queryMember:le,addItem:ne,removeItem:D,updateQty:I,resetPayment:U,handleMoneyClick:j,recalcFromQty:P,recalcFromSubtotal:de,recalcFromPrice:B,toggleCompare:ue,clearCompare:X,isInCompare:Z,submitTransaction:ie,rp:R}}function Le(k=3e4){const d=l(!1);let f=null,m=null;const h=async()=>{try{"wakeLock"in navigator&&(f=await navigator.wakeLock.request("screen"),f.addEventListener("release",()=>{}))}catch(b){console.error(`${b.name}, ${b.message}`)}},y=async()=>{f!==null&&(await f.release(),f=null)},i=async()=>{f!==null&&document.visibilityState==="visible"&&await h()},p=()=>{d.value=!1,m&&clearTimeout(m),m=setTimeout(()=>{d.value=!0},k)},_=()=>{["mousemove","keydown","touchstart","click","scroll"].forEach(w=>{window.addEventListener(w,p)})},F=()=>{["mousemove","keydown","touchstart","click","scroll"].forEach(w=>{window.removeEventListener(w,p)})};return ve(()=>{h(),document.addEventListener("visibilitychange",i),_(),p()}),ge(()=>{y(),document.removeEventListener("visibilitychange",i),F(),m&&clearTimeout(m)}),{isDimmed:d,requestWakeLock:h,releaseWakeLock:y,resetIdleTimer:p}}const $e={class:"flex flex-col lg:flex-row h-[100dvh] w-full bg-gray-100 dark:bg-gray-900 overflow-hidden font-sans transition-colors duration-300"},Ee={class:"relative flex flex-col flex-1 h-full overflow-hidden"},ze={key:0,class:"absolute z-40 bottom-24 lg:bottom-8 right-4 flex items-center bg-gray-900 dark:bg-gray-800 text-white pl-4 pr-1 py-1.5 gap-4 rounded-full shadow-xl animate-bounce-subtle border border-gray-700"},Be={class:"text-xs font-bold whitespace-nowrap"},je={class:"flex items-center gap-1"},Ne={key:1,class:"absolute z-30 lg:hidden bottom-4 left-4 right-4"},Re={class:"flex items-center gap-3"},Ue={class:"flex items-center justify-center text-xs font-bold text-white rounded-full shadow-sm bg-lime-500 dark:bg-white dark:text-lime-700 w-7 h-7"},Oe={class:"flex flex-col items-start leading-none gap-0.5"},Ge={class:"text-lg font-bold"},it={__name:"index",props:{categories:Array,customers:Array,brands:Array,sale:Object,mode:String},setup(k){const f=Ie(k),{isDimmed:m,resetIdleTimer:h}=Le(),{form:y,filterState:i,allProducts:p,filteredProducts:_,isFetchingData:F,dynamicBrands:b,dynamicSizes:w,grandTotal:T,changeAmount:z,isPaymentSufficient:g,hasInvalidQty:o,addItem:M,loadMoreProducts:J,queryProduk:A,queryMember:H,submitTransaction:se,rp:oe,toggleCompare:K,clearCompare:P,isInCompare:de,compareList:B}=f,ne=pe(),D=l(!1),I=l(!1),j=l(!1),U=l(!1),L=l(!1),S=l(!1),$=l(!1),E=l(!1),x=l("product"),W=l(null);l(null),ae(i,async()=>{},{deep:!0});const Y=()=>{U.value=!1,y.reset(),y.items=[]},N=l({id:null,name:"",code:"",price:0,quantity:1,stock:0,unit:"Pcs",image:null}),O=a=>{N.value={id:a.id,name:a.name,code:a.code,image_url:a.image_url,price:parseFloat(a.selling_price||a.price||0),quantity:1,stock:parseInt(a.stock||0),unit:a.unit?.name||"Pcs"},S.value=!0},re=a=>{const t={id:a.id,name:a.name,code:a.code,image_url:a.image_url,price:parseFloat(a.selling_price||a.price||0),quantity:1,stock:parseInt(a.stock||0),unit:a.unit?.name||"Pcs"};M(t)},le=a=>{W.value=a,$.value=!0},V=()=>{x.value="product",I.value=!0},ie=()=>{x.value="member",I.value=!0},R=async a=>{if(I.value=!1,alert("scan berhasil "+x.value+" | "+a),x.value=="product")try{const t=await A(a);t?(a=t,O(a)):alert("Produk tidak ditemukan di database.")}catch(t){console.error("Terjadi kesalahan saat query produk:",t),alert("Gagal mengambil data produk.")}else x.value=="member"&&(a=H(a))},ue=(a=!1)=>{M(N.value),S.value=!1,a&&V()},X=l(0),Z=l(0),e=l(null),s=a=>{L.value=!0,se(a).then(t=>{L.value=!1,j.value=!1,t.success?(X.value=t.change,Z.value=t.total,U.value=!0,e.value?.resetStep(),D.value=!1):ne.success("Transaksi berhasil disimpan.")}).catch(t=>{console.error("Error submitting transaction:",t),L.value=!1})};return(a,t)=>(Q(),ee(we,null,[q(r(be),{title:"Kasir POS"}),q(Me,{show:$.value,product:W.value,onClose:t[0]||(t[0]=n=>$.value=!1),onAddToCart:t[1]||(t[1]=n=>{O(n)})},null,8,["show","product"]),q(Te,{show:E.value,products:r(B),onClose:t[2]||(t[2]=n=>E.value=!1),onRemove:r(K),onAddToCart:t[3]||(t[3]=n=>{O(n)})},null,8,["show","products","onRemove"]),I.value?(Q(),he(qe,{key:0,onResult:R,onClose:t[4]||(t[4]=n=>I.value=!1)})):te("",!0),u("div",$e,[r(m)?(Q(),ee("div",{key:0,onClick:t[5]||(t[5]=ke((...n)=>r(h)&&r(h)(...n),["stop","prevent"])),class:"fixed inset-0 z-[9999] bg-black/90 flex flex-col items-center justify-center cursor-pointer transition-opacity duration-1000"},[...t[21]||(t[21]=[u("div",{class:"text-center animate-pulse"},[u("span",{class:"text-6xl mb-4 block"},"ðŸŒ™"),u("p",{class:"text-white/50 text-sm font-light tracking-widest uppercase"},"Mode Hemat Daya"),u("p",{class:"text-white/30 text-xs mt-2"},"Sentuh layar untuk kembali")],-1)])])):te("",!0),u("div",Ee,[q(Fe,{categories:k.categories,brands:r(b)?.length?r(b):k.brands,sizes:r(w),"is-fetching":r(F),search:r(i).search,"onUpdate:search":t[6]||(t[6]=n=>r(i).search=n),category:r(i).category,"onUpdate:category":t[7]||(t[7]=n=>r(i).category=n),subCategory:r(i).subCategory,"onUpdate:subCategory":t[8]||(t[8]=n=>r(i).subCategory=n),brand:r(i).brand,"onUpdate:brand":t[9]||(t[9]=n=>r(i).brand=n),size:r(i).size,"onUpdate:size":t[10]||(t[10]=n=>r(i).size=n),sort:r(i).sort,"onUpdate:sort":t[11]||(t[11]=n=>r(i).sort=n),hideEmptyStock:r(i).hideEmptyStock,"onUpdate:hideEmptyStock":t[12]||(t[12]=n=>r(i).hideEmptyStock=n),onScan:V},null,8,["categories","brands","sizes","is-fetching","search","category","subCategory","brand","size","sort","hideEmptyStock"]),q(Pe,{products:r(_),"is-fetching":r(F),"cart-items":r(y).items,"all-products-count":r(p).length,"compare-list":r(B),onLoadMore:r(J),onAddToCart:re,onOpenDetail:le,onToggleCompare:r(K)},null,8,["products","is-fetching","cart-items","all-products-count","compare-list","onLoadMore","onToggleCompare"]),r(B)?.length>0?(Q(),ee("div",ze,[u("div",Be,ce(r(B).length)+" Banding ",1),u("div",je,[u("button",{onClick:t[13]||(t[13]=n=>E.value=!0),class:"px-3 py-1.5 bg-lime-500 hover:bg-lime-400 text-black text-xs font-bold rounded-full transition"}," Buka "),u("button",{onClick:t[14]||(t[14]=(...n)=>r(P)&&r(P)(...n)),class:"p-1.5 hover:bg-gray-700 rounded-full text-gray-400 hover:text-white transition"},[...t[22]||(t[22]=[u("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[u("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])])])):te("",!0),r(y).items.length>0?(Q(),ee("div",Ne,[u("button",{onClick:t[15]||(t[15]=n=>D.value=!0),class:"w-full bg-gray-900 dark:bg-lime-600 text-white p-3.5 rounded-2xl shadow-xl shadow-gray-900/20 flex justify-between items-center animate-bounce-subtle"},[u("div",Re,[u("span",Ue,ce(r(y).items.reduce((n,c)=>n+parseFloat(c.quantity),0)),1),u("div",Oe,[t[23]||(t[23]=u("span",{class:"text-[9px] text-gray-400 dark:text-lime-100 uppercase font-bold tracking-wider"},"Total Belanja",-1)),u("span",Ge,ce(r(oe)(r(T))),1)])]),t[24]||(t[24]=u("span",{class:"flex items-center gap-1 px-4 py-2 text-xs font-bold bg-gray-700 dark:bg-lime-800/30 rounded-xl"},[_e(" Bayar "),u("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[u("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M14 5l7 7m0 0l-7 7m7-7H3"})])],-1))])])):te("",!0)]),q(Ce,{ref_key:"cartRef",ref:e,showMobileCart:D.value,reprops:r(f),onOpenScanMember:ie,onShowBayar:t[16]||(t[16]=n=>j.value=!0),onShowDesktop:t[17]||(t[17]=n=>D.value=!1)},null,8,["showMobileCart","reprops"])]),q(De,{show:S.value,item:N.value,"onUpdate:item":t[18]||(t[18]=n=>N.value=n),onClose:t[19]||(t[19]=n=>S.value=!1),onAddToCart:ue},null,8,["show","item"]),q(Se,{showConfirmModal:j.value,changeAmount:r(z),grandTotal:r(T),paymentAmount:parseFloat(r(y).payment_amount),processing:L.value,onClose:t[20]||(t[20]=n=>j.value=!1),onConfirmTransaction:s},null,8,["showConfirmModal","changeAmount","grandTotal","paymentAmount","processing"]),q(Ae,{show:U.value,changeAmount:X.value,total:Z.value,onClose:Y,onNewTransaction:Y},null,8,["show","changeAmount","total"])],64))}};export{it as default};
